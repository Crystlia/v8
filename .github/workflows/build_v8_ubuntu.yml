name: Build V8 for Node.js

on:
  workflow_dispatch:
    inputs:
      v8_version:
        description: 'V8 version to build'
        required: true
        default: '8.4.371.23'

jobs:
  build-v8:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # Construction may take a long time.

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Python 3
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build clang pkg-config git

    - name: Configure depot_tools
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git   
        echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH

    - name: Fetch V8 source
      run: |
        fetch v8
        cd v8
        git checkout refs/tags/${{ inputs.v8_version }}
        gclient sync -D

    - name: Update build scripts
      env:
          MB_SCRIPT: "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojIENvcHlyaWdodCAyMDE2IHRoZSBWOCBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMgQ29weXJpZ2h0IDIwMTUgVGhlIENocm9taXVtIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiMgVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZQojIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCgoiIiJNQiAtIHRoZSBNZXRhLUJ1aWxkIHdyYXBwZXIgYXJvdW5kIEdOLgoKTUIgaXMgYSB3cmFwcGVyIHNjcmlwdCBmb3IgR04gdGhhdCBjYW4gYmUgdXNlZCB0byBnZW5lcmF0ZSBidWlsZCBmaWxlcwpmb3Igc2V0cyBvZiBjYW5uZWQgY29uZmlndXJhdGlvbnMgYW5kIGFuYWx5emUgdGhlbS4KIiIiCgojIGZvciBweTIvcHkzIGNvbXBhdGliaWxpdHkKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBwcmludF9mdW5jdGlvbgoKaW1wb3J0IGFyZ3BhcnNlCmltcG9ydCBhc3QKaW1wb3J0IGVycm5vCmltcG9ydCBqc29uCmltcG9ydCBvcwppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHBwcmludAppbXBvcnQgcmUKaW1wb3J0IHNobGV4CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN5cwppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHRyYWNlYmFjawoKIyBmb3IgcHkyL3B5MyBjb21wYXRpYmlsaXR5CnRyeToKICBmcm9tIHVybGxpYi5wYXJzZSBpbXBvcnQgcXVvdGUKZXhjZXB0IEltcG9ydEVycm9yOgogIGZyb20gdXJsbGliMiBpbXBvcnQgcXVvdGUKdHJ5OgogIGZyb20gdXJsbGliLnJlcXVlc3QgaW1wb3J0IHVybG9wZW4KZXhjZXB0IEltcG9ydEVycm9yOgogIGZyb20gdXJsbGliMiBpbXBvcnQgdXJsb3BlbgoKQ0hST01JVU1fU1JDX0RJUiA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5kaXJuYW1lKAogICAgb3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkpKQpzeXMucGF0aCA9IFtvcy5wYXRoLmpvaW4oQ0hST01JVU1fU1JDX0RJUiwgJ2J1aWxkJyldICsgc3lzLnBhdGgKCmltcG9ydCBnbl9oZWxwZXJzCgp0cnk6CiAgY21wICAgICAgICAgICAgICAjIFB5dGhvbiAyCmV4Y2VwdCBOYW1lRXJyb3I6ICAjIFB5dGhvbiAzCiAgZGVmIGNtcCh4LCB5KTogICAjIHB5bGludDogZGlzYWJsZT1yZWRlZmluZWQtYnVpbHRpbgogICAgcmV0dXJuICh4ID4geSkgLSAoeCA8IHkpCgoKZGVmIF92OF9idWlsZGVyX2ZhbGxiYWNrKGJ1aWxkZXIsIGJ1aWxkZXJfZ3JvdXApOgogICIiIkZhbGxiYWNrIHRvIFY4IGJ1aWxkZXIgbmFtZXMgYmVmb3JlIHNwbGl0dGluZyBidWlsZGVyL3Rlc3Rlci4KCiAgVGhpcyBlYXNlcyBzcGxpdHRpbmcgYnVpbGRlcnMgYW5kIHRlc3RlcnMgb24gcmVsZWFzZSBicmFuY2hlcyBhbmQKICBjYW4gYmUgcmVtb3ZlZCBhcyBzb29uIGFzIGFsbCBidWlsZGVyIGhhdmUgYmVlbiBzcGxpdCBhbmQgYWxsIE1CIGNvbmZpZ3MKICBleGlzdCBvbiBhbGwgYnJhbmNoZXMuCiAgIiIiCiAgYnVpbGRlcnMgPSBbYnVpbGRlcl0KICBpZiBidWlsZGVyLmVuZHN3aXRoKCcgLSBidWlsZGVyJyk6CiAgICBidWlsZGVycy5hcHBlbmQoYnVpbGRlcls6LWxlbignIC0gYnVpbGRlcicpXSkKICBlbGlmIGJ1aWxkZXIuZW5kc3dpdGgoJyBidWlsZGVyJyk6CiAgICBidWlsZGVycy5hcHBlbmQoYnVpbGRlcls6LWxlbignIGJ1aWxkZXInKV0pCgogIGZvciBiIGluIGJ1aWxkZXJzOgogICAgaWYgYiBpbiBidWlsZGVyX2dyb3VwOgogICAgICByZXR1cm4gYnVpbGRlcl9ncm91cFtiXQogIHJldHVybiBOb25lCgoKZGVmIG1haW4oYXJncyk6CiAgbWJ3ID0gTWV0YUJ1aWxkV3JhcHBlcigpCiAgcmV0dXJuIG1idy5NYWluKGFyZ3MpCgoKY2xhc3MgTWV0YUJ1aWxkV3JhcHBlcigpOgogIGRlZiBfX2luaXRfXyhzZWxmKToKICAgIHNlbGYuY2hyb21pdW1fc3JjX2RpciA9IENIUk9NSVVNX1NSQ19ESVIKICAgIHNlbGYuZGVmYXVsdF9jb25maWcgPSBvcy5wYXRoLmpvaW4oc2VsZi5jaHJvbWl1bV9zcmNfZGlyLCAnaW5mcmEnLCAnbWInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWJfY29uZmlnLnB5bCcpCiAgICBzZWxmLmRlZmF1bHRfaXNvbGF0ZV9tYXAgPSBvcy5wYXRoLmpvaW4oc2VsZi5jaHJvbWl1bV9zcmNfZGlyLCAnaW5mcmEnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtYicsICdnbl9pc29sYXRlX21hcC5weWwnKQogICAgc2VsZi5leGVjdXRhYmxlID0gc3lzLmV4ZWN1dGFibGUKICAgIHNlbGYucGxhdGZvcm0gPSBzeXMucGxhdGZvcm0KICAgIHNlbGYuc2VwID0gb3Muc2VwCiAgICBzZWxmLmFyZ3MgPSBhcmdwYXJzZS5OYW1lc3BhY2UoKQogICAgc2VsZi5jb25maWdzID0ge30KICAgIHNlbGYubHVjaV90cnlzZXJ2ZXJzID0ge30KICAgIHNlbGYuYnVpbGRlcl9ncm91cHMgPSB7fQogICAgc2VsZi5taXhpbnMgPSB7fQogICAgc2VsZi5pc29sYXRlX2V4ZSA9ICdpc29sYXRlLmV4ZScgaWYgc2VsZi5wbGF0Zm9ybS5zdGFydHN3aXRoKAogICAgICAgICd3aW4nKSBlbHNlICdpc29sYXRlJwoKICBkZWYgTWFpbihzZWxmLCBhcmdzKToKICAgIHNlbGYuUGFyc2VBcmdzKGFyZ3MpCiAgICB0cnk6CiAgICAgIHJldCA9IHNlbGYuYXJncy5mdW5jKCkKICAgICAgaWYgcmV0OgogICAgICAgIHNlbGYuRHVtcElucHV0RmlsZXMoKQogICAgICByZXR1cm4gcmV0CiAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgIHNlbGYuUHJpbnQoJ2ludGVycnVwdGVkLCBleGl0aW5nJykKICAgICAgcmV0dXJuIDEzMAogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgc2VsZi5EdW1wSW5wdXRGaWxlcygpCiAgICAgIHMgPSB0cmFjZWJhY2suZm9ybWF0X2V4YygpCiAgICAgIGZvciBsIGluIHMuc3BsaXRsaW5lcygpOgogICAgICAgIHNlbGYuUHJpbnQobCkKICAgICAgcmV0dXJuIDEKCiAgZGVmIFBhcnNlQXJncyhzZWxmLCBhcmd2KToKICAgIGRlZiBBZGRDb21tb25PcHRpb25zKHN1YnApOgogICAgICBzdWJwLmFkZF9hcmd1bWVudCgnLWInLCAnLS1idWlsZGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgaGVscD0nYnVpbGRlciBuYW1lIHRvIGxvb2sgdXAgY29uZmlnIGZyb20nKQogICAgICBzdWJwLmFkZF9hcmd1bWVudCgKICAgICAgICAgICctbScsICAnLS1idWlsZGVyLWdyb3VwJywKICAgICAgICAgIGhlbHA9J2J1aWxkZXIgZ3JvdXAgbmFtZSB0byBsb29rIHVwIGNvbmZpZyBmcm9tJykKICAgICAgc3VicC5hZGRfYXJndW1lbnQoJy1jJywgJy0tY29uZmlnJywKICAgICAgICAgICAgICAgICAgICAgICAgaGVscD0nY29uZmlndXJhdGlvbiB0byBhbmFseXplJykKICAgICAgc3VicC5hZGRfYXJndW1lbnQoJy0tcGhhc2UnLAogICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdvcHRpb25hbCBwaGFzZSBuYW1lICh1c2VkIHdoZW4gYnVpbGRlcnMgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkbyBtdWx0aXBsZSBjb21waWxlcyB3aXRoIGRpZmZlcmVudCAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyBpbiBhIHNpbmdsZSBidWlsZCknKQogICAgICBzdWJwLmFkZF9hcmd1bWVudCgnLWYnLCAnLS1jb25maWctZmlsZScsIG1ldGF2YXI9J1BBVEgnLAogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0PXNlbGYuZGVmYXVsdF9jb25maWcsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J3BhdGggdG8gY29uZmlnIGZpbGUgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICcoZGVmYXVsdCBpcyAlKGRlZmF1bHQpcyknKQogICAgICBzdWJwLmFkZF9hcmd1bWVudCgKICAgICAgICAgICctaScsCiAgICAgICAgICAnLS1pc29sYXRlLW1hcC1maWxlJywKICAgICAgICAgIG1ldGF2YXI9J1BBVEgnLAogICAgICAgICAgaGVscD0ncGF0aCB0byBpc29sYXRlIG1hcCBmaWxlICcKICAgICAgICAgICcoZGVmYXVsdCBpcyAlKGRlZmF1bHQpcyknLAogICAgICAgICAgZGVmYXVsdD1bXSwKICAgICAgICAgIGFjdGlvbj0nYXBwZW5kJywKICAgICAgICAgIGRlc3Q9J2lzb2xhdGVfbWFwX2ZpbGVzJykKICAgICAgc3VicC5hZGRfYXJndW1lbnQoCiAgICAgICAgICAnLS1hbmRyb2lkLXZlcnNpb24tY29kZScsCiAgICAgICAgICBoZWxwPSdTZXRzIEdOIGFyZyBhbmRyb2lkX2RlZmF1bHRfdmVyc2lvbl9jb2RlJykKICAgICAgc3VicC5hZGRfYXJndW1lbnQoJy0tYW5kcm9pZC12ZXJzaW9uLW5hbWUnLAogICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdTZXRzIEdOIGFyZyBhbmRyb2lkX2RlZmF1bHRfdmVyc2lvbl9uYW1lJykKICAgICAgc3VicC5hZGRfYXJndW1lbnQoJy1uJywgJy0tZHJ5cnVuJywgYWN0aW9uPSdzdG9yZV90cnVlJywKICAgICAgICAgICAgICAgICAgICAgICAgaGVscD0nRG8gYSBkcnkgcnVuIChpLmUuLCBkbyBub3RoaW5nLCBqdXN0IHByaW50ICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGhlIGNvbW1hbmRzIHRoYXQgd2lsbCBydW4pJykKICAgICAgc3VicC5hZGRfYXJndW1lbnQoJy12JywgJy0tdmVyYm9zZScsIGFjdGlvbj0nc3RvcmVfdHJ1ZScsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J3ZlcmJvc2UgbG9nZ2luZycpCgogICAgcGFyc2VyID0gYXJncGFyc2UuQXJndW1lbnRQYXJzZXIocHJvZz0nbWInKQogICAgc3VicHMgPSBwYXJzZXIuYWRkX3N1YnBhcnNlcnMoKQoKICAgIHN1YnAgPSBzdWJwcy5hZGRfcGFyc2VyKCdhbmFseXplJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J2FuYWx5emUgd2hldGhlciBjaGFuZ2VzIHRvIGEgc2V0IG9mIGZpbGVzICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3dpbGwgY2F1c2UgYSBzZXQgb2YgYmluYXJpZXMgdG8gYmUgcmVidWlsdC4nKQogICAgQWRkQ29tbW9uT3B0aW9ucyhzdWJwKQogICAgc3VicC5hZGRfYXJndW1lbnQoJ3BhdGgnLCBuYXJncz0xLAogICAgICAgICAgICAgICAgICAgICAgaGVscD0ncGF0aCBidWlsZCB3YXMgZ2VuZXJhdGVkIGludG8uJykKICAgIHN1YnAuYWRkX2FyZ3VtZW50KCdpbnB1dF9wYXRoJywgbmFyZ3M9MSwKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J3BhdGggdG8gYSBmaWxlIGNvbnRhaW5pbmcgdGhlIGlucHV0IGFyZ3VtZW50cyAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdhcyBhIEpTT04gb2JqZWN0LicpCiAgICBzdWJwLmFkZF9hcmd1bWVudCgnb3V0cHV0X3BhdGgnLCBuYXJncz0xLAogICAgICAgICAgICAgICAgICAgICAgaGVscD0ncGF0aCB0byBhIGZpbGUgY29udGFpbmluZyB0aGUgb3V0cHV0IGFyZ3VtZW50cyAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdhcyBhIEpTT04gb2JqZWN0LicpCiAgICBzdWJwLmFkZF9hcmd1bWVudCgnLS1qc29uLW91dHB1dCcsCiAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdXcml0ZSBlcnJvcnMgdG8ganNvbi5vdXRwdXQnKQogICAgc3VicC5zZXRfZGVmYXVsdHMoZnVuYz1zZWxmLkNtZEFuYWx5emUpCgogICAgc3VicCA9IHN1YnBzLmFkZF9wYXJzZXIoJ2V4cG9ydCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdwcmludCBvdXQgdGhlIGV4cGFuZGVkIGNvbmZpZ3VyYXRpb24gZm9yJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZWFjaCBidWlsZGVyIGFzIGEgSlNPTiBvYmplY3QnKQogICAgc3VicC5hZGRfYXJndW1lbnQoCiAgICAgICAgJy1mJywKICAgICAgICAnLS1jb25maWctZmlsZScsCiAgICAgICAgbWV0YXZhcj0nUEFUSCcsCiAgICAgICAgZGVmYXVsdD1zZWxmLmRlZmF1bHRfY29uZmlnLAogICAgICAgIGhlbHA9J3BhdGggdG8gY29uZmlnIGZpbGUgKGRlZmF1bHQgaXMgJShkZWZhdWx0KXMpJykKICAgIHN1YnAuc2V0X2RlZmF1bHRzKGZ1bmM9c2VsZi5DbWRFeHBvcnQpCgogICAgc3VicCA9IHN1YnBzLmFkZF9wYXJzZXIoJ2dlbicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdnZW5lcmF0ZSBhIG5ldyBzZXQgb2YgYnVpbGQgZmlsZXMnKQogICAgQWRkQ29tbW9uT3B0aW9ucyhzdWJwKQogICAgc3VicC5hZGRfYXJndW1lbnQoJy0tc3dhcm1pbmctdGFyZ2V0cy1maWxlJywKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J3NhdmUgcnVudGltZSBkZXBlbmRlbmNpZXMgZm9yIHRhcmdldHMgbGlzdGVkICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2luIGZpbGUuJykKICAgIHN1YnAuYWRkX2FyZ3VtZW50KCctLWpzb24tb3V0cHV0JywKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J1dyaXRlIGVycm9ycyB0byBqc29uLm91dHB1dCcpCiAgICBzdWJwLmFkZF9hcmd1bWVudCgncGF0aCcsIG5hcmdzPTEsCiAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdwYXRoIHRvIGdlbmVyYXRlIGJ1aWxkIGludG8nKQogICAgc3VicC5zZXRfZGVmYXVsdHMoZnVuYz1zZWxmLkNtZEdlbikKCiAgICBzdWJwID0gc3VicHMuYWRkX3BhcnNlcignaXNvbGF0ZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdnZW5lcmF0ZSB0aGUgLmlzb2xhdGUgZmlsZXMgZm9yIGEgZ2l2ZW4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdiaW5hcnknKQogICAgQWRkQ29tbW9uT3B0aW9ucyhzdWJwKQogICAgc3VicC5hZGRfYXJndW1lbnQoJ3BhdGgnLCBuYXJncz0xLAogICAgICAgICAgICAgICAgICAgICAgaGVscD0ncGF0aCBidWlsZCB3YXMgZ2VuZXJhdGVkIGludG8nKQogICAgc3VicC5hZGRfYXJndW1lbnQoJ3RhcmdldCcsIG5hcmdzPTEsCiAgICAgICAgICAgICAgICAgICAgICBoZWxwPSduaW5qYSB0YXJnZXQgdG8gZ2VuZXJhdGUgdGhlIGlzb2xhdGUgZm9yJykKICAgIHN1YnAuc2V0X2RlZmF1bHRzKGZ1bmM9c2VsZi5DbWRJc29sYXRlKQoKICAgIHN1YnAgPSBzdWJwcy5hZGRfcGFyc2VyKCdsb29rdXAnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVscD0nbG9vayB1cCB0aGUgY29tbWFuZCBmb3IgYSBnaXZlbiBjb25maWcgb3IgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYnVpbGRlcicpCiAgICBBZGRDb21tb25PcHRpb25zKHN1YnApCiAgICBzdWJwLmFkZF9hcmd1bWVudCgnLS1xdWlldCcsIGRlZmF1bHQ9RmFsc2UsIGFjdGlvbj0nc3RvcmVfdHJ1ZScsCiAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdQcmludCBvdXQganVzdCB0aGUgYXJndW1lbnRzLCAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdkbyBub3QgZW11bGF0ZSB0aGUgb3V0cHV0IG9mIHRoZSBnZW4gc3ViY29tbWFuZC4nKQogICAgc3VicC5hZGRfYXJndW1lbnQoJy0tcmVjdXJzaXZlJywgZGVmYXVsdD1GYWxzZSwgYWN0aW9uPSdzdG9yZV90cnVlJywKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J0xvb2t1cCBhcmd1bWVudHMgZnJvbSBpbXBvcnRlZCBmaWxlcywgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAnaW1wbGllcyAtLXF1aWV0JykKICAgIHN1YnAuc2V0X2RlZmF1bHRzKGZ1bmM9c2VsZi5DbWRMb29rdXApCgogICAgc3VicCA9IHN1YnBzLmFkZF9wYXJzZXIoCiAgICAgICAgJ3J1bicsCiAgICAgICAgaGVscD0nYnVpbGQgYW5kIHJ1biB0aGUgaXNvbGF0ZWQgdmVyc2lvbiBvZiBhICcKICAgICAgICAgICAgICdiaW5hcnknLAogICAgICAgIGZvcm1hdHRlcl9jbGFzcz1hcmdwYXJzZS5SYXdEZXNjcmlwdGlvbkhlbHBGb3JtYXR0ZXIpCiAgICBzdWJwLmRlc2NyaXB0aW9uID0gKAogICAgICAgICdCdWlsZCwgaXNvbGF0ZSwgYW5kIHJ1biB0aGUgZ2l2ZW4gYmluYXJ5IHdpdGggdGhlIGNvbW1hbmQgbGluZVxuJwogICAgICAgICdsaXN0ZWQgaW4gdGhlIGlzb2xhdGUuIFlvdSBtYXkgcGFzcyBleHRyYSBhcmd1bWVudHMgYWZ0ZXIgdGhlXG4nCiAgICAgICAgJ3RhcmdldDsgdXNlICItLSIgaWYgdGhlIGV4dHJhIGFyZ3VtZW50cyBuZWVkIHRvIGluY2x1ZGUgc3dpdGNoZXMuXG4nCiAgICAgICAgJ1xuJwogICAgICAgICdFeGFtcGxlczpcbicKICAgICAgICAnXG4nCiAgICAgICAgJyAgJSB0b29scy9tYi9tYi5weSBydW4gLW0gY2hyb21pdW0ubGludXggLWIgIkxpbnV4IEJ1aWxkZXIiIFxcXG4nCiAgICAgICAgJyAgICAvL291dC9EZWZhdWx0IGNvbnRlbnRfYnJvd3NlcnRlc3RzXG4nCiAgICAgICAgJ1xuJwogICAgICAgICcgICUgdG9vbHMvbWIvbWIucHkgcnVuIG91dC9EZWZhdWx0IGNvbnRlbnRfYnJvd3NlcnRlc3RzXG4nCiAgICAgICAgJ1xuJwogICAgICAgICcgICUgdG9vbHMvbWIvbWIucHkgcnVuIG91dC9EZWZhdWx0IGNvbnRlbnRfYnJvd3NlcnRlc3RzIC0tIFxcXG4nCiAgICAgICAgJyAgICAtLXRlc3QtbGF1bmNoZXItcmV0cnktbGltaXQ9MCcKICAgICAgICAnXG4nCiAgICApCiAgICBBZGRDb21tb25PcHRpb25zKHN1YnApCiAgICBzdWJwLmFkZF9hcmd1bWVudCgnLWonLCAnLS1qb2JzJywgZGVzdD0nam9icycsIHR5cGU9aW50LAogICAgICAgICAgICAgICAgICAgICAgaGVscD0nTnVtYmVyIG9mIGpvYnMgdG8gcGFzcyB0byBuaW5qYScpCiAgICBzdWJwLmFkZF9hcmd1bWVudCgnLS1uby1idWlsZCcsIGRlc3Q9J2J1aWxkJywgZGVmYXVsdD1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgYWN0aW9uPSdzdG9yZV9mYWxzZScsCiAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdEbyBub3QgYnVpbGQsIGp1c3QgaXNvbGF0ZSBhbmQgcnVuJykKICAgIHN1YnAuYWRkX2FyZ3VtZW50KCdwYXRoJywgbmFyZ3M9MSwKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9KCdwYXRoIHRvIGdlbmVyYXRlIGJ1aWxkIGludG8gKG9yIHVzZSkuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJyBUaGlzIGNhbiBiZSBlaXRoZXIgYSByZWd1bGFyIHBhdGggb3IgYSAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnR04tc3R5bGUgc291cmNlLXJlbGF0aXZlIHBhdGggbGlrZSAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLy9vdXQvRGVmYXVsdC4nKSkKICAgIHN1YnAuYWRkX2FyZ3VtZW50KCctZCcsICctLWRpbWVuc2lvbicsIGRlZmF1bHQ9W10sIGFjdGlvbj0nYXBwZW5kJywgbmFyZ3M9MiwKICAgICAgICAgICAgICAgICAgICAgIGRlc3Q9J2RpbWVuc2lvbnMnLCBtZXRhdmFyPSdGT08gYmFyJywKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J2RpbWVuc2lvbiB0byBmaWx0ZXIgb24nKQogICAgc3VicC5hZGRfYXJndW1lbnQoJy0tbm8tZGVmYXVsdC1kaW1lbnNpb25zJywgYWN0aW9uPSdzdG9yZV9mYWxzZScsCiAgICAgICAgICAgICAgICAgICAgICBkZXN0PSdkZWZhdWx0X2RpbWVuc2lvbnMnLCBkZWZhdWx0PVRydWUsCiAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdEbyBub3QgYXV0b21hdGljYWxseSBhZGQgZGltZW5zaW9ucyB0byB0aGUgdGFzaycpCiAgICBzdWJwLmFkZF9hcmd1bWVudCgndGFyZ2V0JywgbmFyZ3M9MSwKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J25pbmphIHRhcmdldCB0byBidWlsZCBhbmQgcnVuJykKICAgIHN1YnAuYWRkX2FyZ3VtZW50KCdleHRyYV9hcmdzJywgbmFyZ3M9JyonLAogICAgICAgICAgICAgICAgICAgICAgaGVscD0oJ2V4dHJhIGFyZ3MgdG8gcGFzcyB0byB0aGUgaXNvbGF0ZSB0byBydW4uIFVzZSAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIi0tIiBhcyB0aGUgZmlyc3QgYXJnIGlmIHlvdSBuZWVkIHRvIHBhc3MgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N3aXRjaGVzJykpCiAgICBzdWJwLnNldF9kZWZhdWx0cyhmdW5jPXNlbGYuQ21kUnVuKQoKICAgIHN1YnAgPSBzdWJwcy5hZGRfcGFyc2VyKCd2YWxpZGF0ZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSd2YWxpZGF0ZSB0aGUgY29uZmlnIGZpbGUnKQogICAgc3VicC5hZGRfYXJndW1lbnQoJy1mJywgJy0tY29uZmlnLWZpbGUnLCBtZXRhdmFyPSdQQVRIJywKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ9c2VsZi5kZWZhdWx0X2NvbmZpZywKICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J3BhdGggdG8gY29uZmlnIGZpbGUgKGRlZmF1bHQgaXMgJShkZWZhdWx0KXMpJykKICAgIHN1YnAuc2V0X2RlZmF1bHRzKGZ1bmM9c2VsZi5DbWRWYWxpZGF0ZSkKCiAgICBzdWJwID0gc3VicHMuYWRkX3BhcnNlcignZ2Vycml0LWJ1aWxkYnVja2V0LWNvbmZpZycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdQcmludCBidWlsZGJ1Y2tldC5jb25maWcgZm9yIGdlcnJpdCAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnKHNlZSBNQiB1c2VyIGd1aWRlKScpCiAgICBzdWJwLmFkZF9hcmd1bWVudCgnLWYnLCAnLS1jb25maWctZmlsZScsIG1ldGF2YXI9J1BBVEgnLAogICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdD1zZWxmLmRlZmF1bHRfY29uZmlnLAogICAgICAgICAgICAgICAgICAgICAgaGVscD0ncGF0aCB0byBjb25maWcgZmlsZSAoZGVmYXVsdCBpcyAlKGRlZmF1bHQpcyknKQogICAgc3VicC5zZXRfZGVmYXVsdHMoZnVuYz1zZWxmLkNtZEJ1aWxkYnVja2V0KQoKICAgIHN1YnAgPSBzdWJwcy5hZGRfcGFyc2VyKCdoZWxwJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J0dldCBoZWxwIG9uIGEgc3ViY29tbWFuZC4nKQogICAgc3VicC5hZGRfYXJndW1lbnQobmFyZ3M9Jz8nLCBhY3Rpb249J3N0b3JlJywgZGVzdD0nc3ViY29tbWFuZCcsCiAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdUaGUgY29tbWFuZCB0byBnZXQgaGVscCBmb3IuJykKICAgIHN1YnAuc2V0X2RlZmF1bHRzKGZ1bmM9c2VsZi5DbWRIZWxwKQoKICAgIHNlbGYuYXJncyA9IHBhcnNlci5wYXJzZV9hcmdzKGFyZ3YpCgogIGRlZiBEdW1wSW5wdXRGaWxlcyhzZWxmKToKCiAgICBkZWYgRHVtcENvbnRlbnRzT2ZGaWxlUGFzc2VkVG8oYXJnX25hbWUsIHBhdGgpOgogICAgICBpZiBwYXRoIGFuZCBzZWxmLkV4aXN0cyhwYXRoKToKICAgICAgICBzZWxmLlByaW50KCJcbiMgVG8gcmVjcmVhdGUgdGhlIGZpbGUgcGFzc2VkIHRvICVzOiIgJSBhcmdfbmFtZSkKICAgICAgICBzZWxmLlByaW50KCIlJSBjYXQgPiAlcyA8PEVPRiIgJSBwYXRoKQogICAgICAgIGNvbnRlbnRzID0gc2VsZi5SZWFkRmlsZShwYXRoKQogICAgICAgIHNlbGYuUHJpbnQoY29udGVudHMpCiAgICAgICAgc2VsZi5QcmludCgiRU9GXG4lXG4iKQoKICAgIGlmIGdldGF0dHIoc2VsZi5hcmdzLCAnaW5wdXRfcGF0aCcsIE5vbmUpOgogICAgICBEdW1wQ29udGVudHNPZkZpbGVQYXNzZWRUbygKICAgICAgICAgICdhcmd2WzBdIChpbnB1dF9wYXRoKScsIHNlbGYuYXJncy5pbnB1dF9wYXRoWzBdKQogICAgaWYgZ2V0YXR0cihzZWxmLmFyZ3MsICdzd2FybWluZ190YXJnZXRzX2ZpbGUnLCBOb25lKToKICAgICAgRHVtcENvbnRlbnRzT2ZGaWxlUGFzc2VkVG8oCiAgICAgICAgICAnLS1zd2FybWluZy10YXJnZXRzLWZpbGUnLCBzZWxmLmFyZ3Muc3dhcm1pbmdfdGFyZ2V0c19maWxlKQoKICBkZWYgQ21kQW5hbHl6ZShzZWxmKToKICAgIHZhbHMgPSBzZWxmLkxvb2t1cCgpCiAgICByZXR1cm4gc2VsZi5SdW5HTkFuYWx5emUodmFscykKCiAgZGVmIENtZEV4cG9ydChzZWxmKToKICAgIHNlbGYuUmVhZENvbmZpZ0ZpbGUoKQogICAgb2JqID0ge30KICAgIGZvciBidWlsZGVyX2dyb3VwLCBidWlsZGVycyBpbiBzZWxmLmJ1aWxkZXJfZ3JvdXBzLml0ZW1zKCk6CiAgICAgIG9ialtidWlsZGVyX2dyb3VwXSA9IHt9CiAgICAgIGZvciBidWlsZGVyIGluIGJ1aWxkZXJzOgogICAgICAgIGNvbmZpZyA9IHNlbGYuYnVpbGRlcl9ncm91cHNbYnVpbGRlcl9ncm91cF1bYnVpbGRlcl0KICAgICAgICBpZiBub3QgY29uZmlnOgogICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgaXNpbnN0YW5jZShjb25maWcsIGRpY3QpOgogICAgICAgICAgYXJncyA9IHtrOiBzZWxmLkZsYXR0ZW5Db25maWcodilbJ2duX2FyZ3MnXQogICAgICAgICAgICAgICAgICBmb3IgaywgdiBpbiBjb25maWcuaXRlbXMoKX0KICAgICAgICBlbGlmIGNvbmZpZy5zdGFydHN3aXRoKCcvLycpOgogICAgICAgICAgYXJncyA9IGNvbmZpZwogICAgICAgIGVsc2U6CiAgICAgICAgICBhcmdzID0gc2VsZi5GbGF0dGVuQ29uZmlnKGNvbmZpZylbJ2duX2FyZ3MnXQogICAgICAgICAgaWYgJ2Vycm9yJyBpbiBhcmdzOgogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBvYmpbYnVpbGRlcl9ncm91cF1bYnVpbGRlcl0gPSBhcmdzCgogICAgIyBEdW1wIG9iamVjdCBhbmQgdHJpbSB0cmFpbGluZyB3aGl0ZXNwYWNlLgogICAgcyA9ICdcbicuam9pbihsLnJzdHJpcCgpIGZvciBsIGluCiAgICAgICAgICAgICAgICAgIGpzb24uZHVtcHMob2JqLCBzb3J0X2tleXM9VHJ1ZSwgaW5kZW50PTIpLnNwbGl0bGluZXMoKSkKICAgIHNlbGYuUHJpbnQocykKICAgIHJldHVybiAwCgogIGRlZiBDbWRHZW4oc2VsZik6CiAgICB2YWxzID0gc2VsZi5Mb29rdXAoKQogICAgcmV0dXJuIHNlbGYuUnVuR05HZW4odmFscykKCiAgZGVmIENtZEhlbHAoc2VsZik6CiAgICBpZiBzZWxmLmFyZ3Muc3ViY29tbWFuZDoKICAgICAgc2VsZi5QYXJzZUFyZ3MoW3NlbGYuYXJncy5zdWJjb21tYW5kLCAnLS1oZWxwJ10pCiAgICBlbHNlOgogICAgICBzZWxmLlBhcnNlQXJncyhbJy0taGVscCddKQoKICBkZWYgQ21kSXNvbGF0ZShzZWxmKToKICAgIHZhbHMgPSBzZWxmLkdldENvbmZpZygpCiAgICBpZiBub3QgdmFsczoKICAgICAgcmV0dXJuIDEKICAgIHJldHVybiBzZWxmLlJ1bkdOSXNvbGF0ZSgpCgogIGRlZiBDbWRMb29rdXAoc2VsZik6CiAgICB2YWxzID0gc2VsZi5Mb29rdXAoKQogICAgZ25fYXJncyA9IHNlbGYuR05BcmdzKHZhbHMsIGV4cGFuZF9pbXBvcnRzPXNlbGYuYXJncy5yZWN1cnNpdmUpCiAgICBpZiBzZWxmLmFyZ3MucXVpZXQgb3Igc2VsZi5hcmdzLnJlY3Vyc2l2ZToKICAgICAgc2VsZi5QcmludChnbl9hcmdzLCBlbmQ9JycpCiAgICBlbHNlOgogICAgICBjbWQgPSBzZWxmLkdOQ21kKCdnZW4nLCAnX3BhdGhfJykKICAgICAgc2VsZi5QcmludCgnXG5Xcml0aW5nICIiIlxcXG4lcyIiIiB0byBfcGF0aF8vYXJncy5nbi5cbicgJSBnbl9hcmdzKQogICAgICBlbnYgPSBOb25lCgogICAgICBzZWxmLlByaW50Q21kKGNtZCwgZW52KQogICAgcmV0dXJuIDAKCiAgZGVmIENtZFJ1bihzZWxmKToKICAgIHZhbHMgPSBzZWxmLkdldENvbmZpZygpCiAgICBpZiBub3QgdmFsczoKICAgICAgcmV0dXJuIDEKCiAgICBidWlsZF9kaXIgPSBzZWxmLmFyZ3MucGF0aFswXQogICAgdGFyZ2V0ID0gc2VsZi5hcmdzLnRhcmdldFswXQoKICAgIGlmIHNlbGYuYXJncy5idWlsZDoKICAgICAgcmV0ID0gc2VsZi5CdWlsZCh0YXJnZXQpCiAgICAgIGlmIHJldDoKICAgICAgICByZXR1cm4gcmV0CiAgICByZXQgPSBzZWxmLlJ1bkdOSXNvbGF0ZSgpCiAgICBpZiByZXQ6CiAgICAgIHJldHVybiByZXQKCiAgICByZXR1cm4gc2VsZi5fUnVuTG9jYWxseUlzb2xhdGVkKGJ1aWxkX2RpciwgdGFyZ2V0KQoKICBkZWYgX1J1bkxvY2FsbHlJc29sYXRlZChzZWxmLCBidWlsZF9kaXIsIHRhcmdldCk6CiAgICBjbWQgPSBbCiAgICAgICAgc2VsZi5QYXRoSm9pbihzZWxmLmNocm9taXVtX3NyY19kaXIsICd0b29scycsICdsdWNpLWdvJywKICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaXNvbGF0ZV9leGUpLAogICAgICAgICdydW4nLAogICAgICAgICctaScsCiAgICAgICAgc2VsZi5Ub1NyY1JlbFBhdGgoJyVzLyVzLmlzb2xhdGUnICUgKGJ1aWxkX2RpciwgdGFyZ2V0KSksCiAgICAgIF0KICAgIGlmIHNlbGYuYXJncy5leHRyYV9hcmdzOgogICAgICBjbWQgKz0gWyctLSddICsgc2VsZi5hcmdzLmV4dHJhX2FyZ3MKICAgIHJldCwgXywgXyA9IHNlbGYuUnVuKGNtZCwgZm9yY2VfdmVyYm9zZT1UcnVlLCBidWZmZXJfb3V0cHV0PUZhbHNlKQogICAgcmV0dXJuIHJldAoKICBkZWYgX0RlZmF1bHREaW1lbnNpb25zKHNlbGYpOgogICAgaWYgbm90IHNlbGYuYXJncy5kZWZhdWx0X2RpbWVuc2lvbnM6CiAgICAgIHJldHVybiBbXQoKICAgICMgVGhpcyBjb2RlIGlzIG5haXZlIGFuZCBqdXN0IHBpY2tzIHJlYXNvbmFibGUgZGVmYXVsdHMgcGVyIHBsYXRmb3JtLgogICAgaWYgc2VsZi5wbGF0Zm9ybSA9PSAnZGFyd2luJzoKICAgICAgb3NfZGltID0gKCdvcycsICdNYWMtMTAuMTInKQogICAgZWxpZiBzZWxmLnBsYXRmb3JtLnN0YXJ0c3dpdGgoJ2xpbnV4Jyk6CiAgICAgIG9zX2RpbSA9ICgnb3MnLCAnVWJ1bnR1LTE2LjA0JykKICAgIGVsaWYgc2VsZi5wbGF0Zm9ybSA9PSAnd2luMzInOgogICAgICBvc19kaW0gPSAoJ29zJywgJ1dpbmRvd3MtMTAnKQogICAgZWxzZToKICAgICAgcmFpc2UgTUJFcnIoJ3VucmVjb2duaXplZCBwbGF0Zm9ybSBzdHJpbmcgIiVzIicgJSBzZWxmLnBsYXRmb3JtKQoKICAgIHJldHVybiBbKCdwb29sJywgJ0Nocm9tZScpLAogICAgICAgICAgICAoJ2NwdScsICd4ODYtNjQnKSwKICAgICAgICAgICAgb3NfZGltXQoKICBkZWYgQ21kQnVpbGRidWNrZXQoc2VsZik6CiAgICBzZWxmLlJlYWRDb25maWdGaWxlKCkKCiAgICBzZWxmLlByaW50KCcjIFRoaXMgZmlsZSB3YXMgZ2VuZXJhdGVkIHVzaW5nICcKICAgICAgICAgICAgICAgJyJ0b29scy9tYi9tYi5weSBnZXJyaXQtYnVpbGRidWNrZXQtY29uZmlnIi4nKQoKICAgIGZvciBsdWNpX3RyeXNlcnZlciBpbiBzb3J0ZWQoc2VsZi5sdWNpX3RyeXNlcnZlcnMpOgogICAgICBzZWxmLlByaW50KCdbYnVja2V0ICJsdWNpLiVzIl0nICUgbHVjaV90cnlzZXJ2ZXIpCiAgICAgIGZvciBib3QgaW4gc29ydGVkKHNlbGYubHVjaV90cnlzZXJ2ZXJzW2x1Y2lfdHJ5c2VydmVyXSk6CiAgICAgICAgc2VsZi5QcmludCgnXHRidWlsZGVyID0gJXMnICUgYm90KQoKICAgIGZvciBidWlsZGVyX2dyb3VwIGluIHNvcnRlZChzZWxmLmJ1aWxkZXJfZ3JvdXBzKToKICAgICAgaWYgYnVpbGRlcl9ncm91cC5zdGFydHN3aXRoKCd0cnlzZXJ2ZXIuJyk6CiAgICAgICAgc2VsZi5QcmludCgnW2J1Y2tldCAiYnVpbGRlcl9ncm91cC4lcyJdJyAlIGJ1aWxkZXJfZ3JvdXApCiAgICAgICAgZm9yIGJvdCBpbiBzb3J0ZWQoc2VsZi5idWlsZGVyX2dyb3Vwc1tidWlsZGVyX2dyb3VwXSk6CiAgICAgICAgICBzZWxmLlByaW50KCdcdGJ1aWxkZXIgPSAlcycgJSBib3QpCgogICAgcmV0dXJuIDAKCiAgZGVmIENtZFZhbGlkYXRlKHNlbGYsIHByaW50X29rPVRydWUpOgogICAgZXJycyA9IFtdCgogICAgIyBSZWFkIHRoZSBmaWxlIHRvIG1ha2Ugc3VyZSBpdCBwYXJzZXMuCiAgICBzZWxmLlJlYWRDb25maWdGaWxlKCkKCiAgICAjIEJ1aWxkIGEgbGlzdCBvZiBhbGwgb2YgdGhlIGNvbmZpZ3MgcmVmZXJlbmNlZCBieSBidWlsZGVycy4KICAgIGFsbF9jb25maWdzID0ge30KICAgIGZvciBidWlsZGVyX2dyb3VwIGluIHNlbGYuYnVpbGRlcl9ncm91cHM6CiAgICAgIGZvciBjb25maWcgaW4gc2VsZi5idWlsZGVyX2dyb3Vwc1tidWlsZGVyX2dyb3VwXS52YWx1ZXMoKToKICAgICAgICBpZiBpc2luc3RhbmNlKGNvbmZpZywgZGljdCk6CiAgICAgICAgICBmb3IgYyBpbiBjb25maWcudmFsdWVzKCk6CiAgICAgICAgICAgIGFsbF9jb25maWdzW2NdID0gYnVpbGRlcl9ncm91cAogICAgICAgIGVsc2U6CiAgICAgICAgICBhbGxfY29uZmlnc1tjb25maWddID0gYnVpbGRlcl9ncm91cAoKICAgICMgQ2hlY2sgdGhhdCBldmVyeSByZWZlcmVuY2VkIGFyZ3MgZmlsZSBvciBjb25maWcgYWN0dWFsbHkgZXhpc3RzLgogICAgZm9yIGNvbmZpZywgbG9jIGluIGFsbF9jb25maWdzLml0ZW1zKCk6CiAgICAgIGlmIGNvbmZpZy5zdGFydHN3aXRoKCcvLycpOgogICAgICAgIGlmIG5vdCBzZWxmLkV4aXN0cyhzZWxmLlRvQWJzUGF0aChjb25maWcpKToKICAgICAgICAgIGVycnMuYXBwZW5kKCdVbmtub3duIGFyZ3MgZmlsZSAiJXMiIHJlZmVyZW5jZWQgZnJvbSAiJXMiLicgJQogICAgICAgICAgICAgICAgICAgICAgKGNvbmZpZywgbG9jKSkKICAgICAgZWxpZiBub3QgY29uZmlnIGluIHNlbGYuY29uZmlnczoKICAgICAgICBlcnJzLmFwcGVuZCgnVW5rbm93biBjb25maWcgIiVzIiByZWZlcmVuY2VkIGZyb20gIiVzIi4nICUKICAgICAgICAgICAgICAgICAgICAoY29uZmlnLCBsb2MpKQoKICAgICMgQ2hlY2sgdGhhdCBldmVyeSBhY3R1YWwgY29uZmlnIGlzIGFjdHVhbGx5IHJlZmVyZW5jZWQuCiAgICBmb3IgY29uZmlnIGluIHNlbGYuY29uZmlnczoKICAgICAgaWYgbm90IGNvbmZpZyBpbiBhbGxfY29uZmlnczoKICAgICAgICBlcnJzLmFwcGVuZCgnVW51c2VkIGNvbmZpZyAiJXMiLicgJSBjb25maWcpCgogICAgIyBGaWd1cmUgb3V0IHRoZSB3aG9sZSBsaXN0IG9mIG1peGlucywgYW5kIGNoZWNrIHRoYXQgZXZlcnkgbWl4aW4KICAgICMgbGlzdGVkIGJ5IGEgY29uZmlnIG9yIGFub3RoZXIgbWl4aW4gYWN0dWFsbHkgZXhpc3RzLgogICAgcmVmZXJlbmNlZF9taXhpbnMgPSBzZXQoKQogICAgZm9yIGNvbmZpZywgbWl4aW5zIGluIHNlbGYuY29uZmlncy5pdGVtcygpOgogICAgICBmb3IgbWl4aW4gaW4gbWl4aW5zOgogICAgICAgIGlmIG5vdCBtaXhpbiBpbiBzZWxmLm1peGluczoKICAgICAgICAgIGVycnMuYXBwZW5kKCdVbmtub3duIG1peGluICIlcyIgcmVmZXJlbmNlZCBieSBjb25maWcgIiVzIi4nICUKICAgICAgICAgICAgICAgICAgICAgIChtaXhpbiwgY29uZmlnKSkKICAgICAgICByZWZlcmVuY2VkX21peGlucy5hZGQobWl4aW4pCgogICAgZm9yIG1peGluIGluIHNlbGYubWl4aW5zOgogICAgICBmb3Igc3ViX21peGluIGluIHNlbGYubWl4aW5zW21peGluXS5nZXQoJ21peGlucycsIFtdKToKICAgICAgICBpZiBub3Qgc3ViX21peGluIGluIHNlbGYubWl4aW5zOgogICAgICAgICAgZXJycy5hcHBlbmQoJ1Vua25vd24gbWl4aW4gIiVzIiByZWZlcmVuY2VkIGJ5IG1peGluICIlcyIuJyAlCiAgICAgICAgICAgICAgICAgICAgICAoc3ViX21peGluLCBtaXhpbikpCiAgICAgICAgcmVmZXJlbmNlZF9taXhpbnMuYWRkKHN1Yl9taXhpbikKCiAgICAjIENoZWNrIHRoYXQgZXZlcnkgbWl4aW4gZGVmaW5lZCBpcyBhY3R1YWxseSByZWZlcmVuY2VkIHNvbWV3aGVyZS4KICAgIGZvciBtaXhpbiBpbiBzZWxmLm1peGluczoKICAgICAgaWYgbm90IG1peGluIGluIHJlZmVyZW5jZWRfbWl4aW5zOgogICAgICAgIGVycnMuYXBwZW5kKCdVbnJlZmVyZW5jZWQgbWl4aW4gIiVzIi4nICUgbWl4aW4pCgogICAgaWYgZXJyczoKICAgICAgcmFpc2UgTUJFcnIoKCdtYiBjb25maWcgZmlsZSAlcyBoYXMgcHJvYmxlbXM6JyAlIHNlbGYuYXJncy5jb25maWdfZmlsZSkgKwogICAgICAgICAgICAgICAgICAgICdcbiAgJyArICdcbiAgJy5qb2luKGVycnMpKQoKICAgIGlmIHByaW50X29rOgogICAgICBzZWxmLlByaW50KCdtYiBjb25maWcgZmlsZSAlcyBsb29rcyBvay4nICUgc2VsZi5hcmdzLmNvbmZpZ19maWxlKQogICAgcmV0dXJuIDAKCiAgZGVmIEdldENvbmZpZyhzZWxmKToKICAgIGJ1aWxkX2RpciA9IHNlbGYuYXJncy5wYXRoWzBdCgogICAgdmFscyA9IHNlbGYuRGVmYXVsdFZhbHMoKQogICAgaWYgc2VsZi5hcmdzLmJ1aWxkZXIgb3Igc2VsZi5hcmdzLmJ1aWxkZXJfZ3JvdXAgb3Igc2VsZi5hcmdzLmNvbmZpZzoKICAgICAgdmFscyA9IHNlbGYuTG9va3VwKCkKICAgICAgIyBSZS1ydW4gZ24gZ2VuIGluIG9yZGVyIHRvIGVuc3VyZSB0aGUgY29uZmlnIGlzIGNvbnNpc3RlbnQgd2l0aCB0aGUKICAgICAgIyBidWlsZCBkaXIuCiAgICAgIHNlbGYuUnVuR05HZW4odmFscykKICAgICAgcmV0dXJuIHZhbHMKCiAgICB0b29sY2hhaW5fcGF0aCA9IHNlbGYuUGF0aEpvaW4oc2VsZi5Ub0Fic1BhdGgoYnVpbGRfZGlyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndG9vbGNoYWluLm5pbmphJykKICAgIGlmIG5vdCBzZWxmLkV4aXN0cyh0b29sY2hhaW5fcGF0aCk6CiAgICAgIHNlbGYuUHJpbnQoJ011c3QgZWl0aGVyIHNwZWNpZnkgYSBwYXRoIHRvIGFuIGV4aXN0aW5nIEdOIGJ1aWxkIGRpciAnCiAgICAgICAgICAgICAgICAgJ29yIHBhc3MgaW4gYSAtbS8tYiBwYWlyIG9yIGEgLWMgZmxhZyB0byBzcGVjaWZ5IHRoZSAnCiAgICAgICAgICAgICAgICAgJ2NvbmZpZ3VyYXRpb24nKQogICAgICByZXR1cm4ge30KCiAgICB2YWxzWydnbl9hcmdzJ10gPSBzZWxmLkdOQXJnc0Zyb21EaXIoYnVpbGRfZGlyKQogICAgcmV0dXJuIHZhbHMKCiAgZGVmIEdOQXJnc0Zyb21EaXIoc2VsZiwgYnVpbGRfZGlyKToKICAgIGFyZ3NfY29udGVudHMgPSAiIgogICAgZ25fYXJnc19wYXRoID0gc2VsZi5QYXRoSm9pbihzZWxmLlRvQWJzUGF0aChidWlsZF9kaXIpLCAnYXJncy5nbicpCiAgICBpZiBzZWxmLkV4aXN0cyhnbl9hcmdzX3BhdGgpOgogICAgICBhcmdzX2NvbnRlbnRzID0gc2VsZi5SZWFkRmlsZShnbl9hcmdzX3BhdGgpCiAgICBnbl9hcmdzID0gW10KICAgIGZvciBsIGluIGFyZ3NfY29udGVudHMuc3BsaXRsaW5lcygpOgogICAgICBmaWVsZHMgPSBsLnNwbGl0KCcgJykKICAgICAgbmFtZSA9IGZpZWxkc1swXQogICAgICB2YWwgPSAnICcuam9pbihmaWVsZHNbMjpdKQogICAgICBnbl9hcmdzLmFwcGVuZCgnJXM9JXMnICUgKG5hbWUsIHZhbCkpCgogICAgcmV0dXJuICcgJy5qb2luKGduX2FyZ3MpCgogIGRlZiBMb29rdXAoc2VsZik6CiAgICB2YWxzID0gc2VsZi5SZWFkSU9TQm90Q29uZmlnKCkKICAgIGlmIG5vdCB2YWxzOgogICAgICBzZWxmLlJlYWRDb25maWdGaWxlKCkKICAgICAgY29uZmlnID0gc2VsZi5Db25maWdGcm9tQXJncygpCiAgICAgIGlmIGNvbmZpZy5zdGFydHN3aXRoKCcvLycpOgogICAgICAgIGlmIG5vdCBzZWxmLkV4aXN0cyhzZWxmLlRvQWJzUGF0aChjb25maWcpKToKICAgICAgICAgIHJhaXNlIE1CRXJyKCdhcmdzIGZpbGUgIiVzIiBub3QgZm91bmQnICUgY29uZmlnKQogICAgICAgIHZhbHMgPSBzZWxmLkRlZmF1bHRWYWxzKCkKICAgICAgICB2YWxzWydhcmdzX2ZpbGUnXSA9IGNvbmZpZwogICAgICBlbHNlOgogICAgICAgIGlmIG5vdCBjb25maWcgaW4gc2VsZi5jb25maWdzOgogICAgICAgICAgcmFpc2UgTUJFcnIoJ0NvbmZpZyAiJXMiIG5vdCBmb3VuZCBpbiAlcycgJQogICAgICAgICAgICAgICAgICAgICAgKGNvbmZpZywgc2VsZi5hcmdzLmNvbmZpZ19maWxlKSkKICAgICAgICB2YWxzID0gc2VsZi5GbGF0dGVuQ29uZmlnKGNvbmZpZykKICAgIHJldHVybiB2YWxzCgogIGRlZiBSZWFkSU9TQm90Q29uZmlnKHNlbGYpOgogICAgaWYgbm90IHNlbGYuYXJncy5idWlsZGVyX2dyb3VwIG9yIG5vdCBzZWxmLmFyZ3MuYnVpbGRlcjoKICAgICAgcmV0dXJuIHt9CiAgICBwYXRoID0gc2VsZi5QYXRoSm9pbihzZWxmLmNocm9taXVtX3NyY19kaXIsICdpb3MnLCAnYnVpbGQnLCAnYm90cycsCiAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFyZ3MuYnVpbGRlcl9ncm91cCwgc2VsZi5hcmdzLmJ1aWxkZXIgKyAnLmpzb24nKQogICAgaWYgbm90IHNlbGYuRXhpc3RzKHBhdGgpOgogICAgICByZXR1cm4ge30KCiAgICBjb250ZW50cyA9IGpzb24ubG9hZHMoc2VsZi5SZWFkRmlsZShwYXRoKSkKICAgIGduX2FyZ3MgPSAnICcuam9pbihjb250ZW50cy5nZXQoJ2duX2FyZ3MnLCBbXSkpCgogICAgdmFscyA9IHNlbGYuRGVmYXVsdFZhbHMoKQogICAgdmFsc1snZ25fYXJncyddID0gZ25fYXJncwogICAgcmV0dXJuIHZhbHMKCiAgZGVmIFJlYWRDb25maWdGaWxlKHNlbGYpOgogICAgaWYgbm90IHNlbGYuRXhpc3RzKHNlbGYuYXJncy5jb25maWdfZmlsZSk6CiAgICAgIHJhaXNlIE1CRXJyKCdjb25maWcgZmlsZSBub3QgZm91bmQgYXQgJXMnICUgc2VsZi5hcmdzLmNvbmZpZ19maWxlKQoKICAgIHRyeToKICAgICAgY29udGVudHMgPSBhc3QubGl0ZXJhbF9ldmFsKHNlbGYuUmVhZEZpbGUoc2VsZi5hcmdzLmNvbmZpZ19maWxlKSkKICAgIGV4Y2VwdCBTeW50YXhFcnJvciBhcyBlOgogICAgICByYWlzZSBNQkVycignRmFpbGVkIHRvIHBhcnNlIGNvbmZpZyBmaWxlICIlcyI6ICVzJyAlCiAgICAgICAgICAgICAgICAgKHNlbGYuYXJncy5jb25maWdfZmlsZSwgZSkpIGZyb20gZQoKICAgIHNlbGYuY29uZmlncyA9IGNvbnRlbnRzWydjb25maWdzJ10KICAgIHNlbGYubHVjaV90cnlzZXJ2ZXJzID0gY29udGVudHMuZ2V0KCdsdWNpX3RyeXNlcnZlcnMnLCB7fSkKICAgIHNlbGYuYnVpbGRlcl9ncm91cHMgPSBjb250ZW50c1snYnVpbGRlcl9ncm91cHMnXQogICAgc2VsZi5taXhpbnMgPSBjb250ZW50c1snbWl4aW5zJ10KCiAgZGVmIFJlYWRJc29sYXRlTWFwKHNlbGYpOgogICAgaWYgbm90IHNlbGYuYXJncy5pc29sYXRlX21hcF9maWxlczoKICAgICAgc2VsZi5hcmdzLmlzb2xhdGVfbWFwX2ZpbGVzID0gW3NlbGYuZGVmYXVsdF9pc29sYXRlX21hcF0KCiAgICBmb3IgZiBpbiBzZWxmLmFyZ3MuaXNvbGF0ZV9tYXBfZmlsZXM6CiAgICAgIGlmIG5vdCBzZWxmLkV4aXN0cyhmKToKICAgICAgICByYWlzZSBNQkVycignaXNvbGF0ZSBtYXAgZmlsZSBub3QgZm91bmQgYXQgJXMnICUgZikKICAgIGlzb2xhdGVfbWFwcyA9IHt9CiAgICBmb3IgaXNvbGF0ZV9tYXAgaW4gc2VsZi5hcmdzLmlzb2xhdGVfbWFwX2ZpbGVzOgogICAgICB0cnk6CiAgICAgICAgaXNvbGF0ZV9tYXAgPSBhc3QubGl0ZXJhbF9ldmFsKHNlbGYuUmVhZEZpbGUoaXNvbGF0ZV9tYXApKQogICAgICAgIGR1cGxpY2F0ZXMgPSBzZXQoaXNvbGF0ZV9tYXApLmludGVyc2VjdGlvbihpc29sYXRlX21hcHMpCiAgICAgICAgaWYgZHVwbGljYXRlczoKICAgICAgICAgIHJhaXNlIE1CRXJyKAogICAgICAgICAgICAgICdEdXBsaWNhdGUgdGFyZ2V0cyBpbiBpc29sYXRlIG1hcCBmaWxlczogJXMuJyAlCiAgICAgICAgICAgICAgJywgJy5qb2luKGR1cGxpY2F0ZXMpKQogICAgICAgIGlzb2xhdGVfbWFwcy51cGRhdGUoaXNvbGF0ZV9tYXApCiAgICAgIGV4Y2VwdCBTeW50YXhFcnJvciBhcyBlOgogICAgICAgIHJhaXNlIE1CRXJyKCdGYWlsZWQgdG8gcGFyc2UgaXNvbGF0ZSBtYXAgZmlsZSAiJXMiOiAlcycgJQogICAgICAgICAgICAgICAgICAgIChpc29sYXRlX21hcCwgZSkpIGZyb20gZQogICAgcmV0dXJuIGlzb2xhdGVfbWFwcwoKICBkZWYgQ29uZmlnRnJvbUFyZ3Moc2VsZik6CiAgICBpZiBzZWxmLmFyZ3MuY29uZmlnOgogICAgICBpZiBzZWxmLmFyZ3MuYnVpbGRlcl9ncm91cCBvciBzZWxmLmFyZ3MuYnVpbGRlcjoKICAgICAgICByYWlzZSBNQkVycigKICAgICAgICAgICdDYW4gbm90IHNwZWNpZmljIGJvdGggLWMvLS1jb25maWcgYW5kIC1tLy0tYnVpbGRlci1ncm91cCBvciAnCiAgICAgICAgICAnLWIvLS1idWlsZGVyJykKCiAgICAgIHJldHVybiBzZWxmLmFyZ3MuY29uZmlnCgogICAgaWYgbm90IHNlbGYuYXJncy5idWlsZGVyX2dyb3VwIG9yIG5vdCBzZWxmLmFyZ3MuYnVpbGRlcjoKICAgICAgcmFpc2UgTUJFcnIoJ011c3Qgc3BlY2lmeSBlaXRoZXIgLWMvLS1jb25maWcgb3IgJwogICAgICAgICAgICAgICAgICAnKC1tLy0tYnVpbGRlci1ncm91cCBhbmQgLWIvLS1idWlsZGVyKScpCgogICAgaWYgbm90IHNlbGYuYXJncy5idWlsZGVyX2dyb3VwIGluIHNlbGYuYnVpbGRlcl9ncm91cHM6CiAgICAgIHJhaXNlIE1CRXJyKCdCdWlsZGVyIGdyb3VwcyBuYW1lICIlcyIgbm90IGZvdW5kIGluICIlcyInICUKICAgICAgICAgICAgICAgICAgKHNlbGYuYXJncy5idWlsZGVyX2dyb3VwLCBzZWxmLmFyZ3MuY29uZmlnX2ZpbGUpKQoKICAgIGNvbmZpZyA9IF92OF9idWlsZGVyX2ZhbGxiYWNrKAogICAgICAgIHNlbGYuYXJncy5idWlsZGVyLCBzZWxmLmJ1aWxkZXJfZ3JvdXBzW3NlbGYuYXJncy5idWlsZGVyX2dyb3VwXSkKCiAgICBpZiBub3QgY29uZmlnOgogICAgICByYWlzZSBNQkVycigKICAgICAgICAnQnVpbGRlciBuYW1lICIlcyIgIG5vdCBmb3VuZCB1bmRlciBidWlsZGVyX2dyb3Vwc1slc10gaW4gIiVzIicgJQogICAgICAgIChzZWxmLmFyZ3MuYnVpbGRlciwgc2VsZi5hcmdzLmJ1aWxkZXJfZ3JvdXAsIHNlbGYuYXJncy5jb25maWdfZmlsZSkpCgogICAgaWYgaXNpbnN0YW5jZShjb25maWcsIGRpY3QpOgogICAgICBpZiBzZWxmLmFyZ3MucGhhc2UgaXMgTm9uZToKICAgICAgICByYWlzZSBNQkVycignTXVzdCBzcGVjaWZ5IGEgYnVpbGQgLS1waGFzZSBmb3IgJXMgb24gJXMnICUKICAgICAgICAgICAgICAgICAgICAoc2VsZi5hcmdzLmJ1aWxkZXIsIHNlbGYuYXJncy5idWlsZGVyX2dyb3VwKSkKICAgICAgcGhhc2UgPSBzdHIoc2VsZi5hcmdzLnBoYXNlKQogICAgICBpZiBwaGFzZSBub3QgaW4gY29uZmlnOgogICAgICAgIHJhaXNlIE1CRXJyKCdQaGFzZSAlcyBkb2VzblwndCBleGlzdCBmb3IgJXMgb24gJXMnICUKICAgICAgICAgICAgICAgICAgICAocGhhc2UsIHNlbGYuYXJncy5idWlsZGVyLCBzZWxmLmFyZ3MuYnVpbGRlcl9ncm91cCkpCiAgICAgIHJldHVybiBjb25maWdbcGhhc2VdCgogICAgaWYgc2VsZi5hcmdzLnBoYXNlIGlzIG5vdCBOb25lOgogICAgICByYWlzZSBNQkVycignTXVzdCBub3Qgc3BlY2lmeSBhIGJ1aWxkIC0tcGhhc2UgZm9yICVzIG9uICVzJyAlCiAgICAgICAgICAgICAgICAgIChzZWxmLmFyZ3MuYnVpbGRlciwgc2VsZi5hcmdzLmJ1aWxkZXJfZ3JvdXApKQogICAgcmV0dXJuIGNvbmZpZwoKICBkZWYgRmxhdHRlbkNvbmZpZyhzZWxmLCBjb25maWcpOgogICAgbWl4aW5zID0gc2VsZi5jb25maWdzW2NvbmZpZ10KICAgIHZhbHMgPSBzZWxmLkRlZmF1bHRWYWxzKCkKCiAgICB2aXNpdGVkID0gW10KICAgIHNlbGYuRmxhdHRlbk1peGlucyhtaXhpbnMsIHZhbHMsIHZpc2l0ZWQpCiAgICByZXR1cm4gdmFscwoKICBkZWYgRGVmYXVsdFZhbHMoc2VsZik6CiAgICByZXR1cm4gewogICAgICAnYXJnc19maWxlJzogJycsCiAgICAgICdjcm9zX3Bhc3N0aHJvdWdoJzogRmFsc2UsCiAgICAgICdnbl9hcmdzJzogJycsCiAgICB9CgogIGRlZiBGbGF0dGVuTWl4aW5zKHNlbGYsIG1peGlucywgdmFscywgdmlzaXRlZCk6CiAgICBmb3IgbSBpbiBtaXhpbnM6CiAgICAgIGlmIG0gbm90IGluIHNlbGYubWl4aW5zOgogICAgICAgIHJhaXNlIE1CRXJyKCdVbmtub3duIG1peGluICIlcyInICUgbSkKCiAgICAgIHZpc2l0ZWQuYXBwZW5kKG0pCgogICAgICBtaXhpbl92YWxzID0gc2VsZi5taXhpbnNbbV0KCiAgICAgIGlmICdjcm9zX3Bhc3N0aHJvdWdoJyBpbiBtaXhpbl92YWxzOgogICAgICAgIHZhbHNbJ2Nyb3NfcGFzc3Rocm91Z2gnXSA9IG1peGluX3ZhbHNbJ2Nyb3NfcGFzc3Rocm91Z2gnXQogICAgICBpZiAnYXJnc19maWxlJyBpbiBtaXhpbl92YWxzOgogICAgICAgIGlmIHZhbHNbJ2FyZ3NfZmlsZSddOgogICAgICAgICAgcmFpc2UgTUJFcnIoJ2FyZ3NfZmlsZSBzcGVjaWZpZWQgbXVsdGlwbGUgdGltZXMgaW4gbWl4aW5zICcKICAgICAgICAgICAgICAgICAgICAgICdmb3IgJXMgb24gJXMnICUKICAgICAgICAgICAgICAgICAgICAgIChzZWxmLmFyZ3MuYnVpbGRlciwgc2VsZi5hcmdzLmJ1aWxkZXJfZ3JvdXApKQogICAgICAgIHZhbHNbJ2FyZ3NfZmlsZSddID0gbWl4aW5fdmFsc1snYXJnc19maWxlJ10KICAgICAgaWYgJ2duX2FyZ3MnIGluIG1peGluX3ZhbHM6CiAgICAgICAgaWYgdmFsc1snZ25fYXJncyddOgogICAgICAgICAgdmFsc1snZ25fYXJncyddICs9ICcgJyArIG1peGluX3ZhbHNbJ2duX2FyZ3MnXQogICAgICAgIGVsc2U6CiAgICAgICAgICB2YWxzWydnbl9hcmdzJ10gPSBtaXhpbl92YWxzWydnbl9hcmdzJ10KCiAgICAgIGlmICdtaXhpbnMnIGluIG1peGluX3ZhbHM6CiAgICAgICAgc2VsZi5GbGF0dGVuTWl4aW5zKG1peGluX3ZhbHNbJ21peGlucyddLCB2YWxzLCB2aXNpdGVkKQogICAgcmV0dXJuIHZhbHMKCiAgZGVmIFJ1bkdOR2VuKHNlbGYsIHZhbHMsIGNvbXB1dGVfZ3JpdF9pbnB1dHNfZm9yX2FuYWx5emU9RmFsc2UpOgogICAgYnVpbGRfZGlyID0gc2VsZi5hcmdzLnBhdGhbMF0KCiAgICBjbWQgPSBzZWxmLkdOQ21kKCdnZW4nLCBidWlsZF9kaXIsICctLWNoZWNrJykKICAgIGduX2FyZ3MgPSBzZWxmLkdOQXJncyh2YWxzKQogICAgaWYgY29tcHV0ZV9ncml0X2lucHV0c19mb3JfYW5hbHl6ZToKICAgICAgZ25fYXJncyArPSAnIGNvbXB1dGVfZ3JpdF9pbnB1dHNfZm9yX2FuYWx5emU9dHJ1ZScKCiAgICAjIFNpbmNlIEdOIGhhc24ndCBydW4geWV0LCB0aGUgYnVpbGQgZGlyZWN0b3J5IG1heSBub3QgZXZlbiBleGlzdC4KICAgIHNlbGYuTWF5YmVNYWtlRGlyZWN0b3J5KHNlbGYuVG9BYnNQYXRoKGJ1aWxkX2RpcikpCgogICAgZ25fYXJnc19wYXRoID0gc2VsZi5Ub0Fic1BhdGgoYnVpbGRfZGlyLCAnYXJncy5nbicpCiAgICBzZWxmLldyaXRlRmlsZShnbl9hcmdzX3BhdGgsIGduX2FyZ3MsIGZvcmNlX3ZlcmJvc2U9VHJ1ZSkKCiAgICBzd2FybWluZ190YXJnZXRzID0gW10KICAgIGlmIGdldGF0dHIoc2VsZi5hcmdzLCAnc3dhcm1pbmdfdGFyZ2V0c19maWxlJywgTm9uZSk6CiAgICAgICMgV2UgbmVlZCBHTiB0byBnZW5lcmF0ZSB0aGUgbGlzdCBvZiBydW50aW1lIGRlcGVuZGVuY2llcyBmb3IKICAgICAgIyB0aGUgY29tcGlsZSB0YXJnZXRzIGxpc3RlZCAob25lIHBlciBsaW5lKSBpbiB0aGUgZmlsZSBzbwogICAgICAjIHdlIGNhbiBydW4gdGhlbSB2aWEgc3dhcm1pbmcuIFdlIHVzZSBnbl9pc29sYXRlX21hcC5weWwgdG8gY29udmVydAogICAgICAjIHRoZSBjb21waWxlIHRhcmdldHMgdG8gdGhlIG1hdGNoaW5nIEdOIGxhYmVscy4KICAgICAgcGF0aCA9IHNlbGYuYXJncy5zd2FybWluZ190YXJnZXRzX2ZpbGUKICAgICAgaWYgbm90IHNlbGYuRXhpc3RzKHBhdGgpOgogICAgICAgIHNlbGYuV3JpdGVGYWlsdXJlQW5kUmFpc2UoJyIlcyIgZG9lcyBub3QgZXhpc3QnICUgcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dF9wYXRoPU5vbmUpCiAgICAgIGNvbnRlbnRzID0gc2VsZi5SZWFkRmlsZShwYXRoKQogICAgICBzd2FybWluZ190YXJnZXRzID0gc2V0KGNvbnRlbnRzLnNwbGl0bGluZXMoKSkKCiAgICAgIGlzb2xhdGVfbWFwID0gc2VsZi5SZWFkSXNvbGF0ZU1hcCgpCiAgICAgIHNlbGYuUmVtb3ZlUG9zc2libHlTdGFsZVJ1bnRpbWVEZXBzRmlsZXModmFscywgc3dhcm1pbmdfdGFyZ2V0cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc29sYXRlX21hcCwgYnVpbGRfZGlyKQogICAgICBlcnIsIGxhYmVscyA9IHNlbGYuTWFwVGFyZ2V0c1RvTGFiZWxzKGlzb2xhdGVfbWFwLCBzd2FybWluZ190YXJnZXRzKQogICAgICBpZiBlcnI6CiAgICAgICAgcmFpc2UgTUJFcnIoZXJyKQoKICAgICAgZ25fcnVudGltZV9kZXBzX3BhdGggPSBzZWxmLlRvQWJzUGF0aChidWlsZF9kaXIsICdydW50aW1lX2RlcHMnKQogICAgICBzZWxmLldyaXRlRmlsZShnbl9ydW50aW1lX2RlcHNfcGF0aCwgJ1xuJy5qb2luKGxhYmVscykgKyAnXG4nKQogICAgICBjbWQuYXBwZW5kKCctLXJ1bnRpbWUtZGVwcy1saXN0LWZpbGU9JXMnICUgZ25fcnVudGltZV9kZXBzX3BhdGgpCgogICAgcmV0LCBvdXRwdXQsIF8gPSBzZWxmLlJ1bihjbWQpCiAgICBpZiByZXQ6CiAgICAgIGlmIHNlbGYuYXJncy5qc29uX291dHB1dDoKICAgICAgICAjIHdyaXRlIGVycm9ycyB0byBqc29uLm91dHB1dAogICAgICAgIHNlbGYuV3JpdGVKU09OKHsnb3V0cHV0Jzogb3V0cHV0fSwgc2VsZi5hcmdzLmpzb25fb3V0cHV0KQogICAgICAjIElmIGBnbiBnZW5gIGZhaWxlZCwgd2Ugc2hvdWxkIGV4aXQgZWFybHkgcmF0aGVyIHRoYW4gdHJ5aW5nIHRvCiAgICAgICMgZ2VuZXJhdGUgaXNvbGF0ZXMuIFJ1bigpIHdpbGwgaGF2ZSBhbHJlYWR5IGxvZ2dlZCBhbnkgZXJyb3Igb3V0cHV0LgogICAgICBzZWxmLlByaW50KCdHTiBnZW4gZmFpbGVkOiAlZCcgJSByZXQpCiAgICAgIHJldHVybiByZXQKCiAgICBhbmRyb2lkID0gJ3RhcmdldF9vcz0iYW5kcm9pZCInIGluIHZhbHNbJ2duX2FyZ3MnXQogICAgZm9yIHRhcmdldCBpbiBzd2FybWluZ190YXJnZXRzOgogICAgICBpZiBhbmRyb2lkOgogICAgICAgICMgQW5kcm9pZCB0YXJnZXRzIG1heSBiZSBlaXRoZXIgYW5kcm9pZF9hcGsgb3IgZXhlY3V0YWJsZS4gVGhlIGZvcm1lcgogICAgICAgICMgd2lsbCByZXN1bHQgaW4gcnVudGltZV9kZXBzIGFzc29jaWF0ZWQgd2l0aCB0aGUgc3RhbXAgZmlsZSwgd2hpbGUgdGhlCiAgICAgICAgIyBsYXR0ZXIgd2lsbCByZXN1bHQgaW4gcnVudGltZV9kZXBzIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXhlY3V0YWJsZS4KICAgICAgICBsYWJlbCA9IGlzb2xhdGVfbWFwW3RhcmdldF1bJ2xhYmVsJ10KICAgICAgICBydW50aW1lX2RlcHNfdGFyZ2V0cyA9IFsKICAgICAgICAgICAgdGFyZ2V0ICsgJy5ydW50aW1lX2RlcHMnLAogICAgICAgICAgICAnb2JqLyVzLnJ1bnRpbWVfZGVwcycgJSBsYWJlbC5yZXBsYWNlKCc6JywgJy8nKSwKICAgICAgICAgICAgJ29iai8lcy5zdGFtcC5ydW50aW1lX2RlcHMnICUgbGFiZWwucmVwbGFjZSgnOicsICcvJyldCiAgICAgIGVsaWYgKGlzb2xhdGVfbWFwW3RhcmdldF1bJ3R5cGUnXSA9PSAnc2NyaXB0JyBvcgogICAgICAgICAgICBpc29sYXRlX21hcFt0YXJnZXRdLmdldCgnbGFiZWxfdHlwZScpID09ICdncm91cCcpOgogICAgICAgICMgRm9yIHNjcmlwdCB0YXJnZXRzLCB0aGUgYnVpbGQgdGFyZ2V0IGlzIHVzdWFsbHkgYSBncm91cCwKICAgICAgICAjIGZvciB3aGljaCBnbiBnZW5lcmF0ZXMgdGhlIHJ1bnRpbWVfZGVwcyBuZXh0IHRvIHRoZSBzdGFtcCBmaWxlCiAgICAgICAgIyBmb3IgdGhlIGxhYmVsLCB3aGljaCBsaXZlcyB1bmRlciB0aGUgb2JqLyBkaXJlY3RvcnksIGJ1dCBpdCBtYXkKICAgICAgICAjIGFsc28gYmUgYW4gZXhlY3V0YWJsZS4KICAgICAgICBsYWJlbCA9IGlzb2xhdGVfbWFwW3RhcmdldF1bJ2xhYmVsJ10KICAgICAgICBydW50aW1lX2RlcHNfdGFyZ2V0cyA9IFsKICAgICAgICAgICAgJ29iai8lcy5ydW50aW1lX2RlcHMnICUgbGFiZWwucmVwbGFjZSgnOicsICcvJyksCiAgICAgICAgICAgICdvYmovJXMuc3RhbXAucnVudGltZV9kZXBzJyAlIGxhYmVsLnJlcGxhY2UoJzonLCAnLycpXQogICAgICAgIGlmIHNlbGYucGxhdGZvcm0gPT0gJ3dpbjMyJzoKICAgICAgICAgIHJ1bnRpbWVfZGVwc190YXJnZXRzICs9IFsgdGFyZ2V0ICsgJy5leGUucnVudGltZV9kZXBzJyBdCiAgICAgICAgZWxzZToKICAgICAgICAgIHJ1bnRpbWVfZGVwc190YXJnZXRzICs9IFsgdGFyZ2V0ICsgJy5ydW50aW1lX2RlcHMnIF0KICAgICAgZWxpZiBzZWxmLnBsYXRmb3JtID09ICd3aW4zMic6CiAgICAgICAgcnVudGltZV9kZXBzX3RhcmdldHMgPSBbdGFyZ2V0ICsgJy5leGUucnVudGltZV9kZXBzJ10KICAgICAgZWxzZToKICAgICAgICBydW50aW1lX2RlcHNfdGFyZ2V0cyA9IFt0YXJnZXQgKyAnLnJ1bnRpbWVfZGVwcyddCgogICAgICBmb3IgciBpbiBydW50aW1lX2RlcHNfdGFyZ2V0czoKICAgICAgICBydW50aW1lX2RlcHNfcGF0aCA9IHNlbGYuVG9BYnNQYXRoKGJ1aWxkX2RpciwgcikKICAgICAgICBpZiBzZWxmLkV4aXN0cyhydW50aW1lX2RlcHNfcGF0aCk6CiAgICAgICAgICBicmVhawogICAgICBlbHNlOgogICAgICAgIHJhaXNlIE1CRXJyKCdkaWQgbm90IGdlbmVyYXRlIGFueSBvZiAlcycgJQogICAgICAgICAgICAgICAgICAgICcsICcuam9pbihydW50aW1lX2RlcHNfdGFyZ2V0cykpCgogICAgICBydW50aW1lX2RlcHMgPSBzZWxmLlJlYWRGaWxlKHJ1bnRpbWVfZGVwc19wYXRoKS5zcGxpdGxpbmVzKCkKCiAgICAgIHNlbGYuV3JpdGVJc29sYXRlRmlsZXMoYnVpbGRfZGlyLCB0YXJnZXQsIHJ1bnRpbWVfZGVwcykKCiAgICByZXR1cm4gMAoKICBkZWYgUnVuR05Jc29sYXRlKHNlbGYpOgogICAgdGFyZ2V0ID0gc2VsZi5hcmdzLnRhcmdldFswXQogICAgaXNvbGF0ZV9tYXAgPSBzZWxmLlJlYWRJc29sYXRlTWFwKCkKICAgIGVyciwgbGFiZWxzID0gc2VsZi5NYXBUYXJnZXRzVG9MYWJlbHMoaXNvbGF0ZV9tYXAsIFt0YXJnZXRdKQogICAgaWYgZXJyOgogICAgICByYWlzZSBNQkVycihlcnIpCiAgICBsYWJlbCA9IGxhYmVsc1swXQoKICAgIGJ1aWxkX2RpciA9IHNlbGYuYXJncy5wYXRoWzBdCgogICAgY21kID0gc2VsZi5HTkNtZCgnZGVzYycsIGJ1aWxkX2RpciwgbGFiZWwsICdydW50aW1lX2RlcHMnKQogICAgcmV0LCBvdXQsIF8gPSBzZWxmLkNhbGwoY21kKQogICAgaWYgcmV0OgogICAgICBpZiBvdXQ6CiAgICAgICAgc2VsZi5QcmludChvdXQpCiAgICAgIHJldHVybiByZXQKCiAgICBydW50aW1lX2RlcHMgPSBvdXQuc3BsaXRsaW5lcygpCgogICAgc2VsZi5Xcml0ZUlzb2xhdGVGaWxlcyhidWlsZF9kaXIsIHRhcmdldCwgcnVudGltZV9kZXBzKQoKICAgIHJldCwgXywgXyA9IHNlbGYuUnVuKFsKICAgICAgICBzZWxmLlBhdGhKb2luKHNlbGYuY2hyb21pdW1fc3JjX2RpciwgJ3Rvb2xzJywgJ2x1Y2ktZ28nLAogICAgICAgICAgICAgICAgICAgICAgc2VsZi5pc29sYXRlX2V4ZSksCiAgICAgICAgJ2NoZWNrJywKICAgICAgICAnLWknLAogICAgICAgIHNlbGYuVG9TcmNSZWxQYXRoKCclcy8lcy5pc29sYXRlJyAlIChidWlsZF9kaXIsIHRhcmdldCkpXSwKICAgICAgICBidWZmZXJfb3V0cHV0PUZhbHNlKQoKICAgIHJldHVybiByZXQKCiAgZGVmIFJlbW92ZVBvc3NpYmx5U3RhbGVSdW50aW1lRGVwc0ZpbGVzKHNlbGYsIHZhbHMsIHRhcmdldHMsIGlzb2xhdGVfbWFwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWlsZF9kaXIpOgogICAgIyBUT0RPKGNyYnVnLmNvbS80MTQ0MTcyNCk6IEJlY2F1c2UgYGduIGdlbiAtLXJ1bnRpbWUtZGVwcy1saXN0LWZpbGVgCiAgICAjIHB1dHMgdGhlIHJ1bnRpbWVfZGVwcyBmaWxlIGluIGRpZmZlcmVudCBsb2NhdGlvbnMgYmFzZWQgb24gdGhlIGFjdHVhbAogICAgIyB0eXBlIG9mIGEgdGFyZ2V0LCB3ZSBtYXkgZW5kIHVwIHdpdGggbXVsdGlwbGUgcG9zc2libGUgcnVudGltZV9kZXBzCiAgICAjIGZpbGVzIGluIGEgZ2l2ZW4gYnVpbGQgZGlyZWN0b3J5LCB3aGVyZSBzb21lIG9mIHRoZSBlbnRyaWVzIG1pZ2h0IGJlCiAgICAjIHN0YWxlIChzaW5jZSB3ZSBtaWdodCBiZSByZXVzaW5nIGFuIGV4aXN0aW5nIGJ1aWxkIGRpcmVjdG9yeSkuCiAgICAjCiAgICAjIFdlIG5lZWQgdG8gYmUgYWJsZSB0byBnZXQgdGhlIHJpZ2h0IG9uZSByZWxpYWJseTsgeW91IG1pZ2h0IHRoaW5rCiAgICAjIHdlIGNhbiBqdXN0IHBpY2sgdGhlIG5ld2VzdCBmaWxlLCBidXQgYmVjYXVzZSBHTiB3b24ndCB1cGRhdGUgdGltZXN0YW1wcwogICAgIyBpZiB0aGUgY29udGVudHMgb2YgdGhlIGZpbGVzIGNoYW5nZSwgYW4gb2xkZXIgcnVudGltZV9kZXBzCiAgICAjIGZpbGUgbWlnaHQgYWN0dWFsbHkgYmUgdGhlIG9uZSB3ZSBzaG91bGQgdXNlIG92ZXIgYSBuZXdlciBvbmUgKHNlZQogICAgIyBjcmJ1Zy5jb20vOTMyMzg3IGZvciBhIG1vcmUgY29tcGxldGUgZXhwbGFuYXRpb24gYW5kIGV4YW1wbGUpLgogICAgIwogICAgIyBJbiBvcmRlciB0byBhdm9pZCB0aGlzLCB3ZSBuZWVkIHRvIGRlbGV0ZSBhbnkgcG9zc2libGUgcnVudGltZV9kZXBzCiAgICAjIGZpbGVzICpwcmlvciogdG8gcnVubmluZyBHTi4gQXMgbG9uZyBhcyB0aGUgZmlsZXMgYXJlbid0IGFjdHVhbGx5CiAgICAjIG5lZWRlZCBkdXJpbmcgdGhlIGJ1aWxkLCB0aGlzIGhvcGVmdWxseSB3aWxsIG5vdCBjYXVzZSB1bm5lY2Vzc2FyeQogICAgIyBidWlsZCB3b3JrLCBhbmQgc28gaXQgc2hvdWxkIGJlIHNhZmUuCiAgICAjCiAgICAjIFVsdGltYXRlbHksIHdlIHNob3VsZCBqdXN0IG1ha2Ugc3VyZSB3ZSBnZXQgdGhlIHJ1bnRpbWVfZGVwcyBmaWxlcwogICAgIyBpbiBwcmVkaWN0YWJsZSBsb2NhdGlvbnMgc28gd2UgZG9uJ3QgaGF2ZSB0aGlzIGlzc3VlIGF0IGFsbCwgYW5kCiAgICAjIHRoYXQncyB3aGF0IGNyYnVnLmNvbS85MzI3MDAgaXMgZm9yLgogICAgcG9zc2libGVfcnBhdGhzID0gc2VsZi5Qb3NzaWJsZVJ1bnRpbWVEZXBzUGF0aHModmFscywgdGFyZ2V0cywgaXNvbGF0ZV9tYXApCiAgICBmb3IgcnBhdGhzIGluIHBvc3NpYmxlX3JwYXRocy52YWx1ZXMoKToKICAgICAgZm9yIHJwYXRoIGluIHJwYXRoczoKICAgICAgICBwYXRoID0gc2VsZi5Ub0Fic1BhdGgoYnVpbGRfZGlyLCBycGF0aCkKICAgICAgICBpZiBzZWxmLkV4aXN0cyhwYXRoKToKICAgICAgICAgIHNlbGYuUmVtb3ZlRmlsZShwYXRoKQoKICBkZWYgUG9zc2libGVSdW50aW1lRGVwc1BhdGhzKHNlbGYsIHZhbHMsIG5pbmphX3RhcmdldHMsIGlzb2xhdGVfbWFwKToKICAgICIiIlJldHVybnMgYSBtYXAgb2YgdGFyZ2V0cyB0byBwb3NzaWJsZSAucnVudGltZV9kZXBzIHBhdGhzLgoKICAgIEVhY2ggbmluamEgdGFyZ2V0IG1hcHMgb24gdG8gYSBHTiBsYWJlbCwgYnV0IGRlcGVuZGluZyBvbiB0aGUgdHlwZQogICAgb2YgdGhlIEdOIHRhcmdldCwgYGduIGdlbiAtLXJ1bnRpbWUtZGVwcy1saXN0LWZpbGVgIHdpbGwgd3JpdGUKICAgIHRoZSAucnVudGltZV9kZXBzIGZpbGVzIGludG8gZGlmZmVyZW50IGxvY2F0aW9ucy4gVW5mb3J0dW5hdGVseSwgaW4KICAgIHNvbWUgY2FzZXMgd2UgZG9uJ3QgYWN0dWFsbHkga25vdyB3aGljaCBvZiBtdWx0aXBsZSBsb2NhdGlvbnMgd2lsbAogICAgYWN0dWFsbHkgYmUgdXNlZCwgc28gd2UgcmV0dXJuIGFsbCBwbGF1c2libGUgY2FuZGlkYXRlcy4KCiAgICBUaGUgcGF0aHMgdGhhdCBhcmUgcmV0dXJuZWQgYXJlIHJlbGF0aXZlIHRvIHRoZSBidWlsZCBkaXJlY3RvcnkuCiAgICAiIiIKCiAgICBhbmRyb2lkID0gJ3RhcmdldF9vcz0iYW5kcm9pZCInIGluIHZhbHNbJ2duX2FyZ3MnXQogICAgaW9zID0gJ3RhcmdldF9vcz0iaW9zIicgaW4gdmFsc1snZ25fYXJncyddCiAgICBmdWNoc2lhID0gJ3RhcmdldF9vcz0iZnVjaHNpYSInIGluIHZhbHNbJ2duX2FyZ3MnXQogICAgd2luID0gc2VsZi5wbGF0Zm9ybSA9PSAnd2luMzInIG9yICd0YXJnZXRfb3M9IndpbiInIGluIHZhbHNbJ2duX2FyZ3MnXQogICAgcG9zc2libGVfcnVudGltZV9kZXBzX3JwYXRocyA9IHt9CiAgICBmb3IgdGFyZ2V0IGluIG5pbmphX3RhcmdldHM6CiAgICAgIHRhcmdldF90eXBlID0gaXNvbGF0ZV9tYXBbdGFyZ2V0XVsndHlwZSddCiAgICAgIGxhYmVsID0gaXNvbGF0ZV9tYXBbdGFyZ2V0XVsnbGFiZWwnXQogICAgICB0YXJnZXRfcnVudGltZV9kZXBzID0gJ29iai8lcy5ydW50aW1lX2RlcHMnICUgbGFiZWwucmVwbGFjZSgnOicsICcvJykKICAgICAgc3RhbXBfcnVudGltZV9kZXBzID0gJ29iai8lcy5zdGFtcC5ydW50aW1lX2RlcHMnICUgbGFiZWwucmVwbGFjZSgnOicsICcvJykKICAgICAgIyBUT0RPKGNyYnVnLmNvbS80MDU5MDE5Nik6ICdvZmZpY2lhbF90ZXN0cycgdXNlCiAgICAgICMgdHlwZT0nYWRkaXRpb25hbF9jb21waWxlX3RhcmdldCcgdG8gaXNvbGF0ZSB0ZXN0cy4gVGhpcyBpcyBub3QgdGhlCiAgICAgICMgaW50ZW5kZWQgdXNlIGZvciAnYWRkaXRpb25hbF9jb21waWxlX3RhcmdldCcuCiAgICAgIGlmICh0YXJnZXRfdHlwZSA9PSAnYWRkaXRpb25hbF9jb21waWxlX3RhcmdldCcgYW5kCiAgICAgICAgICB0YXJnZXQgIT0gJ29mZmljaWFsX3Rlc3RzJyk6CiAgICAgICAgIyBCeSBkZWZpbml0aW9uLCBhZGRpdGlvbmFsX2NvbXBpbGVfdGFyZ2V0cyBhcmUgbm90IHRlc3RzLCBzbyB3ZQogICAgICAgICMgc2hvdWxkbid0IGdlbmVyYXRlIGlzb2xhdGVzIGZvciB0aGVtLgogICAgICAgIHJhaXNlIE1CRXJyKCdDYW5ub3QgZ2VuZXJhdGUgaXNvbGF0ZSBmb3IgJXMgc2luY2UgaXQgaXMgYW4gJwogICAgICAgICAgICAgICAgICAgICdhZGRpdGlvbmFsX2NvbXBpbGVfdGFyZ2V0LicgJSB0YXJnZXQpCiAgICAgIGlmIGZ1Y2hzaWEgb3IgaW9zIG9yIHRhcmdldF90eXBlID09ICdnZW5lcmF0ZWRfc2NyaXB0JzoKICAgICAgICAjIGlPUyBhbmQgRnVjaHNpYSB0YXJnZXRzIGVuZCB1cCBhcyBncm91cHMuCiAgICAgICAgIyBnZW5lcmF0ZWRfc2NyaXB0IHRhcmdldHMgYXJlIGFsd2F5cyBhY3Rpb25zLgogICAgICAgIHJwYXRocyA9IFtzdGFtcF9ydW50aW1lX2RlcHMsIHRhcmdldF9ydW50aW1lX2RlcHNdCiAgICAgIGVsaWYgYW5kcm9pZDoKICAgICAgICAjIEFuZHJvaWQgdGFyZ2V0cyBtYXkgYmUgZWl0aGVyIGFuZHJvaWRfYXBrIG9yIGV4ZWN1dGFibGUuIFRoZSBmb3JtZXIKICAgICAgICAjIHdpbGwgcmVzdWx0IGluIHJ1bnRpbWVfZGVwcyBhc3NvY2lhdGVkIHdpdGggdGhlIHN0YW1wIGZpbGUsIHdoaWxlIHRoZQogICAgICAgICMgbGF0dGVyIHdpbGwgcmVzdWx0IGluIHJ1bnRpbWVfZGVwcyBhc3NvY2lhdGVkIHdpdGggdGhlIGV4ZWN1dGFibGUuCiAgICAgICAgbGFiZWwgPSBpc29sYXRlX21hcFt0YXJnZXRdWydsYWJlbCddCiAgICAgICAgcnBhdGhzID0gWwogICAgICAgICAgICB0YXJnZXQgKyAnLnJ1bnRpbWVfZGVwcycsIHN0YW1wX3J1bnRpbWVfZGVwcywgdGFyZ2V0X3J1bnRpbWVfZGVwcwogICAgICAgIF0KICAgICAgZWxpZiAodGFyZ2V0X3R5cGUgPT0gJ3NjcmlwdCcgb3IKICAgICAgICAgICAgaXNvbGF0ZV9tYXBbdGFyZ2V0XS5nZXQoJ2xhYmVsX3R5cGUnKSA9PSAnZ3JvdXAnKToKICAgICAgICAjIEZvciBzY3JpcHQgdGFyZ2V0cywgdGhlIGJ1aWxkIHRhcmdldCBpcyB1c3VhbGx5IGEgZ3JvdXAsCiAgICAgICAgIyBmb3Igd2hpY2ggZ24gZ2VuZXJhdGVzIHRoZSBydW50aW1lX2RlcHMgbmV4dCB0byB0aGUgc3RhbXAgZmlsZQogICAgICAgICMgZm9yIHRoZSBsYWJlbCwgd2hpY2ggbGl2ZXMgdW5kZXIgdGhlIG9iai8gZGlyZWN0b3J5LCBidXQgaXQgbWF5CiAgICAgICAgIyBhbHNvIGJlIGFuIGV4ZWN1dGFibGUuCiAgICAgICAgbGFiZWwgPSBpc29sYXRlX21hcFt0YXJnZXRdWydsYWJlbCddCiAgICAgICAgcnBhdGhzID0gW3N0YW1wX3J1bnRpbWVfZGVwcywgdGFyZ2V0X3J1bnRpbWVfZGVwc10KICAgICAgICBpZiB3aW46CiAgICAgICAgICBycGF0aHMgKz0gW3RhcmdldCArICcuZXhlLnJ1bnRpbWVfZGVwcyddCiAgICAgICAgZWxzZToKICAgICAgICAgIHJwYXRocyArPSBbdGFyZ2V0ICsgJy5ydW50aW1lX2RlcHMnXQogICAgICBlbGlmIHdpbjoKICAgICAgICBycGF0aHMgPSBbdGFyZ2V0ICsgJy5leGUucnVudGltZV9kZXBzJ10KICAgICAgZWxzZToKICAgICAgICBycGF0aHMgPSBbdGFyZ2V0ICsgJy5ydW50aW1lX2RlcHMnXQoKICAgICAgcG9zc2libGVfcnVudGltZV9kZXBzX3JwYXRoc1t0YXJnZXRdID0gcnBhdGhzCgogICAgcmV0dXJuIHBvc3NpYmxlX3J1bnRpbWVfZGVwc19ycGF0aHMKCiAgZGVmIFdyaXRlSXNvbGF0ZUZpbGVzKHNlbGYsIGJ1aWxkX2RpciwgdGFyZ2V0LCBydW50aW1lX2RlcHMpOgogICAgaXNvbGF0ZV9wYXRoID0gc2VsZi5Ub0Fic1BhdGgoYnVpbGRfZGlyLCB0YXJnZXQgKyAnLmlzb2xhdGUnKQogICAgc2VsZi5Xcml0ZUZpbGUoaXNvbGF0ZV9wYXRoLAogICAgICBwcHJpbnQucGZvcm1hdCh7CiAgICAgICAgJ3ZhcmlhYmxlcyc6IHsKICAgICAgICAgICdmaWxlcyc6IHNvcnRlZChydW50aW1lX2RlcHMpLAogICAgICAgIH0KICAgICAgfSkgKyAnXG4nKQoKICAgIHNlbGYuV3JpdGVKU09OKAogICAgICB7CiAgICAgICAgJ2FyZ3MnOiBbCiAgICAgICAgICAnLS1pc29sYXRlJywKICAgICAgICAgIHNlbGYuVG9TcmNSZWxQYXRoKCclcy8lcy5pc29sYXRlJyAlIChidWlsZF9kaXIsIHRhcmdldCkpLAogICAgICAgIF0sCiAgICAgICAgJ2Rpcic6IHNlbGYuY2hyb21pdW1fc3JjX2RpciwKICAgICAgICAndmVyc2lvbic6IDEsCiAgICAgIH0sCiAgICAgIGlzb2xhdGVfcGF0aCArICdkLmdlbi5qc29uJywKICAgICkKCiAgZGVmIE1hcFRhcmdldHNUb0xhYmVscyhzZWxmLCBpc29sYXRlX21hcCwgdGFyZ2V0cyk6CiAgICBsYWJlbHMgPSBbXQogICAgZXJyID0gJycKCiAgICBmb3IgdGFyZ2V0IGluIHRhcmdldHM6CiAgICAgIGlmIHRhcmdldCA9PSAnYWxsJzoKICAgICAgICBsYWJlbHMuYXBwZW5kKHRhcmdldCkKICAgICAgZWxpZiB0YXJnZXQuc3RhcnRzd2l0aCgnLy8nKToKICAgICAgICBsYWJlbHMuYXBwZW5kKHRhcmdldCkKICAgICAgZWxzZToKICAgICAgICBpZiB0YXJnZXQgaW4gaXNvbGF0ZV9tYXA6CiAgICAgICAgICBpZiBpc29sYXRlX21hcFt0YXJnZXRdWyd0eXBlJ10gPT0gJ3Vua25vd24nOgogICAgICAgICAgICBlcnIgKz0gKCd0ZXN0IHRhcmdldCAiJXMiIHR5cGUgaXMgdW5rbm93blxuJyAlIHRhcmdldCkKICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxhYmVscy5hcHBlbmQoaXNvbGF0ZV9tYXBbdGFyZ2V0XVsnbGFiZWwnXSkKICAgICAgICBlbHNlOgogICAgICAgICAgZXJyICs9ICgndGFyZ2V0ICIlcyIgbm90IGZvdW5kIGluICcKICAgICAgICAgICAgICAgICAgJy8vaW5mcmEvbWIvZ25faXNvbGF0ZV9tYXAucHlsXG4nICUgdGFyZ2V0KQoKICAgIHJldHVybiBlcnIsIGxhYmVscwoKICBkZWYgR05DbWQoc2VsZiwgc3ViY29tbWFuZCwgcGF0aCwgKmFyZ3MpOgogICAgaWYgc2VsZi5wbGF0Zm9ybS5zdGFydHN3aXRoKCdsaW51eCcpOgogICAgICBzdWJkaXIsIGV4ZSA9ICdsaW51eDY0JywgJ2duJwogICAgZWxpZiBzZWxmLnBsYXRmb3JtID09ICdkYXJ3aW4nOgogICAgICBzdWJkaXIsIGV4ZSA9ICdtYWMnLCAnZ24nCiAgICBlbHNlOgogICAgICBzdWJkaXIsIGV4ZSA9ICd3aW4nLCAnZ24uZXhlJwoKICAgIGFyY2ggPSBwbGF0Zm9ybS5tYWNoaW5lKCkKICAgIGlmIChhcmNoLnN0YXJ0c3dpdGgoJ3MzOTAnKSBvciBhcmNoLnN0YXJ0c3dpdGgoJ3BwYycpIG9yCiAgICAgICAgc2VsZi5wbGF0Zm9ybS5zdGFydHN3aXRoKCdhaXgnKSk6CiAgICAgICMgdXNlIGduIGluIFBBVEgKICAgICAgZ25fcGF0aCA9ICdnbicKICAgIGVsc2U6CiAgICAgIGduX3BhdGggPSBzZWxmLlBhdGhKb2luKHNlbGYuY2hyb21pdW1fc3JjX2RpciwgJ2J1aWxkdG9vbHMnLCBzdWJkaXIsIGV4ZSkKICAgIHJldHVybiBbZ25fcGF0aCwgc3ViY29tbWFuZCwgcGF0aF0gKyBsaXN0KGFyZ3MpCgoKICBkZWYgR05BcmdzKHNlbGYsIHZhbHMsIGV4cGFuZF9pbXBvcnRzPUZhbHNlKToKICAgIGlmIHZhbHNbJ2Nyb3NfcGFzc3Rocm91Z2gnXToKICAgICAgaWYgbm90ICdHTl9BUkdTJyBpbiBvcy5lbnZpcm9uOgogICAgICAgIHJhaXNlIE1CRXJyKCdNQiBpcyBleHBlY3RpbmcgR05fQVJHUyB0byBiZSBpbiB0aGUgZW52aXJvbm1lbnQnKQogICAgICBnbl9hcmdzID0gb3MuZW52aXJvblsnR05fQVJHUyddCiAgICAgIGlmIG5vdCByZS5zZWFyY2goJ3RhcmdldF9vcy4qPS4qImNocm9tZW9zIicsIGduX2FyZ3MpOgogICAgICAgIHJhaXNlIE1CRXJyKCdHTl9BUkdTIGlzIG1pc3NpbmcgdGFyZ2V0X29zID0gImNocm9tZW9zIjogKEdOX0FSR1M9JXMpJyAlCiAgICAgICAgICAgICAgICAgICAgZ25fYXJncykKICAgIGVsc2U6CiAgICAgIGduX2FyZ3MgPSB2YWxzWydnbl9hcmdzJ10KCiAgICBhbmRyb2lkX3ZlcnNpb25fY29kZSA9IHNlbGYuYXJncy5hbmRyb2lkX3ZlcnNpb25fY29kZQogICAgaWYgYW5kcm9pZF92ZXJzaW9uX2NvZGU6CiAgICAgIGduX2FyZ3MgKz0gJyBhbmRyb2lkX2RlZmF1bHRfdmVyc2lvbl9jb2RlPSIlcyInICUgYW5kcm9pZF92ZXJzaW9uX2NvZGUKCiAgICBhbmRyb2lkX3ZlcnNpb25fbmFtZSA9IHNlbGYuYXJncy5hbmRyb2lkX3ZlcnNpb25fbmFtZQogICAgaWYgYW5kcm9pZF92ZXJzaW9uX25hbWU6CiAgICAgIGduX2FyZ3MgKz0gJyBhbmRyb2lkX2RlZmF1bHRfdmVyc2lvbl9uYW1lPSIlcyInICUgYW5kcm9pZF92ZXJzaW9uX25hbWUKCiAgICBhcmdzX2duX2xpbmVzID0gW10KICAgIHBhcnNlZF9nbl9hcmdzID0ge30KCiAgICBhcmdzX2ZpbGUgPSB2YWxzLmdldCgnYXJnc19maWxlJywgTm9uZSkKICAgIGlmIGFyZ3NfZmlsZToKICAgICAgaWYgZXhwYW5kX2ltcG9ydHM6CiAgICAgICAgY29udGVudCA9IHNlbGYuUmVhZEZpbGUoc2VsZi5Ub0Fic1BhdGgoYXJnc19maWxlKSkKICAgICAgICBwYXJzZWRfZ25fYXJncyA9IGduX2hlbHBlcnMuRnJvbUdOQXJncyhjb250ZW50KQogICAgICBlbHNlOgogICAgICAgIGFyZ3NfZ25fbGluZXMuYXBwZW5kKCdpbXBvcnQoIiVzIiknICUgYXJnc19maWxlKQoKICAgICMgQ2Fub25pY2FsaXplIHRoZSBhcmcgc3RyaW5nIGludG8gYSBzb3J0ZWQsIG5ld2xpbmUtc2VwYXJhdGVkIGxpc3QKICAgICMgb2Yga2V5LXZhbHVlIHBhaXJzLCBhbmQgZGUtZHVwIHRoZSBrZXlzIGlmIG5lZWQgYmUgc28gdGhhdCBvbmx5CiAgICAjIHRoZSBsYXN0IGluc3RhbmNlIG9mIGVhY2ggYXJnIGlzIGxpc3RlZC4KICAgIHBhcnNlZF9nbl9hcmdzLnVwZGF0ZShnbl9oZWxwZXJzLkZyb21HTkFyZ3MoZ25fYXJncykpCiAgICBhcmdzX2duX2xpbmVzLmFwcGVuZChnbl9oZWxwZXJzLlRvR05TdHJpbmcocGFyc2VkX2duX2FyZ3MpKQoKICAgIHJldHVybiAnXG4nLmpvaW4oYXJnc19nbl9saW5lcykKCiAgZGVmIFRvQWJzUGF0aChzZWxmLCBidWlsZF9wYXRoLCAqY29tcHMpOgogICAgcmV0dXJuIHNlbGYuUGF0aEpvaW4oc2VsZi5jaHJvbWl1bV9zcmNfZGlyLAogICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5Ub1NyY1JlbFBhdGgoYnVpbGRfcGF0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAqY29tcHMpCgogIGRlZiBUb1NyY1JlbFBhdGgoc2VsZiwgcGF0aCk6CiAgICAiIiJSZXR1cm5zIGEgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSB0b3Agb2YgdGhlIHJlcG8uIiIiCiAgICBpZiBwYXRoLnN0YXJ0c3dpdGgoJy8vJyk6CiAgICAgIHJldHVybiBwYXRoWzI6XS5yZXBsYWNlKCcvJywgc2VsZi5zZXApCiAgICByZXR1cm4gc2VsZi5SZWxQYXRoKHBhdGgsIHNlbGYuY2hyb21pdW1fc3JjX2RpcikKCiAgZGVmIFJ1bkdOQW5hbHl6ZShzZWxmLCB2YWxzKToKICAgICMgQW5hbHl6ZSBydW5zIGJlZm9yZSAnZ24gZ2VuJyBub3csIHNvIHdlIG5lZWQgdG8gcnVuIGduIGdlbgogICAgIyBpbiBvcmRlciB0byBlbnN1cmUgdGhhdCB3ZSBoYXZlIGEgYnVpbGQgZGlyZWN0b3J5LgogICAgcmV0ID0gc2VsZi5SdW5HTkdlbih2YWxzLCBjb21wdXRlX2dyaXRfaW5wdXRzX2Zvcl9hbmFseXplPVRydWUpCiAgICBpZiByZXQ6CiAgICAgIHJldHVybiByZXQKCiAgICBidWlsZF9wYXRoID0gc2VsZi5hcmdzLnBhdGhbMF0KICAgIGlucHV0X3BhdGggPSBzZWxmLmFyZ3MuaW5wdXRfcGF0aFswXQogICAgZ25faW5wdXRfcGF0aCA9IGlucHV0X3BhdGggKyAnLmduJwogICAgb3V0cHV0X3BhdGggPSBzZWxmLmFyZ3Mub3V0cHV0X3BhdGhbMF0KICAgIGduX291dHB1dF9wYXRoID0gb3V0cHV0X3BhdGggKyAnLmduJwoKICAgIGlucCA9IHNlbGYuUmVhZElucHV0SlNPTihbJ2ZpbGVzJywgJ3Rlc3RfdGFyZ2V0cycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhZGRpdGlvbmFsX2NvbXBpbGVfdGFyZ2V0cyddKQogICAgaWYgc2VsZi5hcmdzLnZlcmJvc2U6CiAgICAgIHNlbGYuUHJpbnQoKQogICAgICBzZWxmLlByaW50KCdhbmFseXplIGlucHV0OicpCiAgICAgIHNlbGYuUHJpbnRKU09OKGlucCkKICAgICAgc2VsZi5QcmludCgpCgoKICAgICMgVGhpcyBzaG91bGRuJ3Qgbm9ybWFsbHkgaGFwcGVuLCBidXQgY291bGQgZHVlIHRvIHVudXN1YWwgcmFjZSBjb25kaXRpb25zLAogICAgIyBsaWtlIGEgdHJ5IGpvYiB0aGF0IGdldHMgc2NoZWR1bGVkIGJlZm9yZSBhIHBhdGNoIGxhbmRzIGJ1dCBydW5zIGFmdGVyCiAgICAjIHRoZSBwYXRjaCBoYXMgbGFuZGVkLgogICAgaWYgbm90IGlucFsnZmlsZXMnXToKICAgICAgc2VsZi5QcmludCgnV2FybmluZzogTm8gZmlsZXMgbW9kaWZpZWQgaW4gcGF0Y2gsIGJhaWxpbmcgb3V0IGVhcmx5LicpCiAgICAgIHNlbGYuV3JpdGVKU09OKHsKICAgICAgICAgICAgJ3N0YXR1cyc6ICdObyBkZXBlbmRlbmN5JywKICAgICAgICAgICAgJ2NvbXBpbGVfdGFyZ2V0cyc6IFtdLAogICAgICAgICAgICAndGVzdF90YXJnZXRzJzogW10sCiAgICAgICAgICB9LCBvdXRwdXRfcGF0aCkKICAgICAgcmV0dXJuIDAKCiAgICBnbl9pbnAgPSB7fQogICAgZ25faW5wWydmaWxlcyddID0gWycvLycgKyBmIGZvciBmIGluIGlucFsnZmlsZXMnXSBpZiBub3QgZi5zdGFydHN3aXRoKCcvLycpXQoKICAgIGlzb2xhdGVfbWFwID0gc2VsZi5SZWFkSXNvbGF0ZU1hcCgpCiAgICBlcnIsIGduX2lucFsnYWRkaXRpb25hbF9jb21waWxlX3RhcmdldHMnXSA9IHNlbGYuTWFwVGFyZ2V0c1RvTGFiZWxzKAogICAgICAgIGlzb2xhdGVfbWFwLCBpbnBbJ2FkZGl0aW9uYWxfY29tcGlsZV90YXJnZXRzJ10pCiAgICBpZiBlcnI6CiAgICAgIHJhaXNlIE1CRXJyKGVycikKCiAgICBlcnIsIGduX2lucFsndGVzdF90YXJnZXRzJ10gPSBzZWxmLk1hcFRhcmdldHNUb0xhYmVscygKICAgICAgICBpc29sYXRlX21hcCwgaW5wWyd0ZXN0X3RhcmdldHMnXSkKICAgIGlmIGVycjoKICAgICAgcmFpc2UgTUJFcnIoZXJyKQogICAgbGFiZWxzX3RvX3RhcmdldHMgPSB7fQogICAgZm9yIGksIGxhYmVsIGluIGVudW1lcmF0ZShnbl9pbnBbJ3Rlc3RfdGFyZ2V0cyddKToKICAgICAgbGFiZWxzX3RvX3RhcmdldHNbbGFiZWxdID0gaW5wWyd0ZXN0X3RhcmdldHMnXVtpXQoKICAgIHRyeToKICAgICAgc2VsZi5Xcml0ZUpTT04oZ25faW5wLCBnbl9pbnB1dF9wYXRoKQogICAgICBjbWQgPSBzZWxmLkdOQ21kKCdhbmFseXplJywgYnVpbGRfcGF0aCwgZ25faW5wdXRfcGF0aCwgZ25fb3V0cHV0X3BhdGgpCiAgICAgIHJldCwgb3V0cHV0LCBfID0gc2VsZi5SdW4oY21kLCBmb3JjZV92ZXJib3NlPVRydWUpCiAgICAgIGlmIHJldDoKICAgICAgICBpZiBzZWxmLmFyZ3MuanNvbl9vdXRwdXQ6CiAgICAgICAgICAjIHdyaXRlIGVycm9ycyB0byBqc29uLm91dHB1dAogICAgICAgICAgc2VsZi5Xcml0ZUpTT04oeydvdXRwdXQnOiBvdXRwdXR9LCBzZWxmLmFyZ3MuanNvbl9vdXRwdXQpCiAgICAgICAgcmV0dXJuIHJldAoKICAgICAgZ25fb3V0cF9zdHIgPSBzZWxmLlJlYWRGaWxlKGduX291dHB1dF9wYXRoKQogICAgICB0cnk6CiAgICAgICAgZ25fb3V0cCA9IGpzb24ubG9hZHMoZ25fb3V0cF9zdHIpCiAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBzZWxmLlByaW50KCJGYWlsZWQgdG8gcGFyc2UgdGhlIEpTT04gc3RyaW5nIEdOIHJldHVybmVkOiAlc1xuJXMiCiAgICAgICAgICAgICAgICAgICAlIChyZXByKGduX291dHBfc3RyKSwgc3RyKGUpKSkKICAgICAgICByYWlzZQoKICAgICAgb3V0cCA9IHt9CiAgICAgIGlmICdzdGF0dXMnIGluIGduX291dHA6CiAgICAgICAgb3V0cFsnc3RhdHVzJ10gPSBnbl9vdXRwWydzdGF0dXMnXQogICAgICBpZiAnZXJyb3InIGluIGduX291dHA6CiAgICAgICAgb3V0cFsnZXJyb3InXSA9IGduX291dHBbJ2Vycm9yJ10KICAgICAgaWYgJ2ludmFsaWRfdGFyZ2V0cycgaW4gZ25fb3V0cDoKICAgICAgICBvdXRwWydpbnZhbGlkX3RhcmdldHMnXSA9IGduX291dHBbJ2ludmFsaWRfdGFyZ2V0cyddCiAgICAgIGlmICdjb21waWxlX3RhcmdldHMnIGluIGduX291dHA6CiAgICAgICAgYWxsX2lucHV0X2NvbXBpbGVfdGFyZ2V0cyA9IHNvcnRlZCgKICAgICAgICAgICAgc2V0KGlucFsndGVzdF90YXJnZXRzJ10gKyBpbnBbJ2FkZGl0aW9uYWxfY29tcGlsZV90YXJnZXRzJ10pKQoKICAgICAgICAjIElmIHdlJ3JlIGJ1aWxkaW5nICdhbGwnLCB3ZSBjYW4gdGhyb3cgYXdheSB0aGUgcmVzdCBvZiB0aGUgdGFyZ2V0cwogICAgICAgICMgc2luY2UgdGhleSdyZSByZWR1bmRhbnQuCiAgICAgICAgaWYgJ2FsbCcgaW4gZ25fb3V0cFsnY29tcGlsZV90YXJnZXRzJ106CiAgICAgICAgICBvdXRwWydjb21waWxlX3RhcmdldHMnXSA9IFsnYWxsJ10KICAgICAgICBlbHNlOgogICAgICAgICAgb3V0cFsnY29tcGlsZV90YXJnZXRzJ10gPSBnbl9vdXRwWydjb21waWxlX3RhcmdldHMnXQoKICAgICAgICAjIGNyYnVnLmNvbS83MzYyMTU6IFdoZW4gR04gcmV0dXJucyB0YXJnZXRzIGJhY2ssIGZvciB0YXJnZXRzIGluCiAgICAgICAgIyB0aGUgZGVmYXVsdCB0b29sY2hhaW4sIEdOIHdpbGwgaGF2ZSBnZW5lcmF0ZWQgYSBwaG9ueSBuaW5qYQogICAgICAgICMgdGFyZ2V0IG1hdGNoaW5nIHRoZSBsYWJlbCwgYW5kIHNvIHdlIGNhbiBzYWZlbHkgKGFuZCBlYXNpbHkpCiAgICAgICAgIyB0cmFuc2Zvcm0gYW55IEdOIGxhYmVsIGludG8gdGhlIG1hdGNoaW5nIG5pbmphIHRhcmdldC4gRm9yCiAgICAgICAgIyB0YXJnZXRzIGluIG90aGVyIHRvb2xjaGFpbnMsIHRob3VnaCwgR04gZG9lc24ndCBnZW5lcmF0ZSB0aGUKICAgICAgICAjIHBob255IHRhcmdldHMsIGFuZCB3ZSBkb24ndCBrbm93IGhvdyB0byB0dXJuIHRoZSBsYWJlbHMgaW50bwogICAgICAgICMgY29tcGlsZSB0YXJnZXRzLiBJbiB0aGlzIGNhc2UsIHdlIGFsc28gY29uc2VydmF0aXZlbHkgZ2l2ZSB1cAogICAgICAgICMgYW5kIGJ1aWxkIGV2ZXJ5dGhpbmcuIFByb2JhYmx5IHRoZSByaWdodCB0aGluZyB0byBkbyBoZXJlIGlzCiAgICAgICAgIyB0byBoYXZlIEdOIHJldHVybiB0aGUgY29tcGlsZSB0YXJnZXRzIGRpcmVjdGx5LgogICAgICAgIGlmIGFueSgiKCIgaW4gdGFyZ2V0IGZvciB0YXJnZXQgaW4gb3V0cFsnY29tcGlsZV90YXJnZXRzJ10pOgogICAgICAgICAgc2VsZi5QcmludCgnV0FSTklORzogdGFyZ2V0cyB3aXRoIG5vbi1kZWZhdWx0IHRvb2xjaGFpbnMgd2VyZSAnCiAgICAgICAgICAgICAgICAgICAgICdmb3VuZCwgYnVpbGRpbmcgZXZlcnl0aGluZyBpbnN0ZWFkLicpCiAgICAgICAgICBvdXRwWydjb21waWxlX3RhcmdldHMnXSA9IGFsbF9pbnB1dF9jb21waWxlX3RhcmdldHMKICAgICAgICBlbHNlOgogICAgICAgICAgb3V0cFsnY29tcGlsZV90YXJnZXRzJ10gPSBbCiAgICAgICAgICAgICAgbGFiZWwucmVwbGFjZSgnLy8nLCAnJykgZm9yIGxhYmVsIGluIG91dHBbJ2NvbXBpbGVfdGFyZ2V0cyddXQoKICAgICAgICAjIFdpbmRvd3MgaGFzIGEgbWF4aW11bSBjb21tYW5kIGxpbmUgbGVuZ3RoIG9mIDhrOyBldmVuIExpbnV4CiAgICAgICAgIyBtYXhlcyBvdXQgYXQgMTI4azsgaWYgYW5hbHl6ZSByZXR1cm5zIGEgKnJlYWxseSBsb25nKiBsaXN0IG9mCiAgICAgICAgIyB0YXJnZXRzLCB3ZSBqdXN0IGdpdmUgdXAgYW5kIGNvbnNlcnZhdGl2ZWx5IGJ1aWxkIGV2ZXJ5dGhpbmcgaW5zdGVhZC4KICAgICAgICAjIFByb2JhYmx5IHRoZSByaWdodCB0aGluZyBoZXJlIGlzIGZvciBuaW5qYSB0byBzdXBwb3J0IHJlc3BvbnNlCiAgICAgICAgIyBmaWxlcyBhcyBpbnB1dCBvbiB0aGUgY29tbWFuZCBsaW5lCiAgICAgICAgIyAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9uaW5qYS1idWlsZC9uaW5qYS9pc3N1ZXMvMTM1NSkuCiAgICAgICAgaWYgbGVuKCcgJy5qb2luKG91dHBbJ2NvbXBpbGVfdGFyZ2V0cyddKSkgPiA3KjEwMjQ6CiAgICAgICAgICBzZWxmLlByaW50KCdXQVJOSU5HOiBUb28gbWFueSBjb21waWxlIHRhcmdldHMgd2VyZSBhZmZlY3RlZC4nKQogICAgICAgICAgc2VsZi5QcmludCgnV0FSTklORzogQnVpbGRpbmcgZXZlcnl0aGluZyBpbnN0ZWFkIHRvIGF2b2lkICcKICAgICAgICAgICAgICAgICAgICAgJ2NvbW1hbmQtbGluZSBsZW5ndGggaXNzdWVzLicpCiAgICAgICAgICBvdXRwWydjb21waWxlX3RhcmdldHMnXSA9IGFsbF9pbnB1dF9jb21waWxlX3RhcmdldHMKCgogICAgICBpZiAndGVzdF90YXJnZXRzJyBpbiBnbl9vdXRwOgogICAgICAgIG91dHBbJ3Rlc3RfdGFyZ2V0cyddID0gWwogICAgICAgICAgbGFiZWxzX3RvX3RhcmdldHNbbGFiZWxdIGZvciBsYWJlbCBpbiBnbl9vdXRwWyd0ZXN0X3RhcmdldHMnXV0KCiAgICAgIGlmIHNlbGYuYXJncy52ZXJib3NlOgogICAgICAgIHNlbGYuUHJpbnQoKQogICAgICAgIHNlbGYuUHJpbnQoJ2FuYWx5emUgb3V0cHV0OicpCiAgICAgICAgc2VsZi5QcmludEpTT04ob3V0cCkKICAgICAgICBzZWxmLlByaW50KCkKCiAgICAgIHNlbGYuV3JpdGVKU09OKG91dHAsIG91dHB1dF9wYXRoKQoKICAgIGZpbmFsbHk6CiAgICAgIGlmIHNlbGYuRXhpc3RzKGduX2lucHV0X3BhdGgpOgogICAgICAgIHNlbGYuUmVtb3ZlRmlsZShnbl9pbnB1dF9wYXRoKQogICAgICBpZiBzZWxmLkV4aXN0cyhnbl9vdXRwdXRfcGF0aCk6CiAgICAgICAgc2VsZi5SZW1vdmVGaWxlKGduX291dHB1dF9wYXRoKQoKICAgIHJldHVybiAwCgogIGRlZiBSZWFkSW5wdXRKU09OKHNlbGYsIHJlcXVpcmVkX2tleXMpOgogICAgcGF0aCA9IHNlbGYuYXJncy5pbnB1dF9wYXRoWzBdCiAgICBvdXRwdXRfcGF0aCA9IHNlbGYuYXJncy5vdXRwdXRfcGF0aFswXQogICAgaWYgbm90IHNlbGYuRXhpc3RzKHBhdGgpOgogICAgICBzZWxmLldyaXRlRmFpbHVyZUFuZFJhaXNlKCciJXMiIGRvZXMgbm90IGV4aXN0JyAlIHBhdGgsIG91dHB1dF9wYXRoKQoKICAgIHRyeToKICAgICAgaW5wID0ganNvbi5sb2FkcyhzZWxmLlJlYWRGaWxlKHBhdGgpKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICBzZWxmLldyaXRlRmFpbHVyZUFuZFJhaXNlKCdGYWlsZWQgdG8gcmVhZCBKU09OIGlucHV0IGZyb20gIiVzIjogJXMnICUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocGF0aCwgZSksIG91dHB1dF9wYXRoKQoKICAgIGZvciBrIGluIHJlcXVpcmVkX2tleXM6CiAgICAgIGlmIG5vdCBrIGluIGlucDoKICAgICAgICBzZWxmLldyaXRlRmFpbHVyZUFuZFJhaXNlKCdpbnB1dCBmaWxlIGlzIG1pc3NpbmcgYSAiJXMiIGtleScgJSBrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0X3BhdGgpCgogICAgcmV0dXJuIGlucAoKICBkZWYgV3JpdGVGYWlsdXJlQW5kUmFpc2Uoc2VsZiwgbXNnLCBvdXRwdXRfcGF0aCk6CiAgICBpZiBvdXRwdXRfcGF0aDoKICAgICAgc2VsZi5Xcml0ZUpTT04oeydlcnJvcic6IG1zZ30sIG91dHB1dF9wYXRoLCBmb3JjZV92ZXJib3NlPVRydWUpCiAgICByYWlzZSBNQkVycihtc2cpCgogIGRlZiBXcml0ZUpTT04oc2VsZiwgb2JqLCBwYXRoLCBmb3JjZV92ZXJib3NlPUZhbHNlKToKICAgIHRyeToKICAgICAgc2VsZi5Xcml0ZUZpbGUocGF0aCwganNvbi5kdW1wcyhvYmosIGluZGVudD0yLCBzb3J0X2tleXM9VHJ1ZSkgKyAnXG4nLAogICAgICAgICAgICAgICAgICAgICBmb3JjZV92ZXJib3NlPWZvcmNlX3ZlcmJvc2UpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgIHJhaXNlIE1CRXJyKCdFcnJvciAlcyB3cml0aW5nIHRvIHRoZSBvdXRwdXQgcGF0aCAiJXMiJyAlCiAgICAgICAgICAgICAgICAgKGUsIHBhdGgpKSBmcm9tIGUKCiAgZGVmIENoZWNrQ29tcGlsZShzZWxmLCBidWlsZGVyX2dyb3VwLCBidWlsZGVyKToKICAgIHVybF90ZW1wbGF0ZSA9IHNlbGYuYXJncy51cmxfdGVtcGxhdGUgKyAnL3tidWlsZGVyfS9idWlsZHMvX2FsbD9hc190ZXh0PTEnCiAgICB1cmwgPSBxdW90ZSgKICAgICAgICAgICAgdXJsX3RlbXBsYXRlLmZvcm1hdChidWlsZGVyX2dyb3VwPWJ1aWxkZXJfZ3JvdXAsIGJ1aWxkZXI9YnVpbGRlciksCiAgICAgICAgICAgIHNhZmU9JzovKCk/PScpCiAgICB0cnk6CiAgICAgIGJ1aWxkcyA9IGpzb24ubG9hZHMoc2VsZi5GZXRjaCh1cmwpKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICByZXR1cm4gc3RyKGUpCiAgICBzdWNjZXNzZXMgPSBzb3J0ZWQoCiAgICAgICAgW2ludCh4KSBmb3IgeCBpbiBidWlsZHMua2V5cygpIGlmICJ0ZXh0IiBpbiBidWlsZHNbeF0gYW5kCiAgICAgICAgICBjbXAoYnVpbGRzW3hdWyJ0ZXh0Il1bOjJdLCBbImJ1aWxkIiwgInN1Y2Nlc3NmdWwiXSkgPT0gMF0sCiAgICAgICAgcmV2ZXJzZT1UcnVlKQogICAgaWYgbm90IHN1Y2Nlc3NlczoKICAgICAgcmV0dXJuICJubyBzdWNjZXNzZnVsIGJ1aWxkcyIKICAgIGJ1aWxkID0gYnVpbGRzW3N0cihzdWNjZXNzZXNbMF0pXQogICAgc3RlcF9uYW1lcyA9IHtzdGVwWyJuYW1lIl0gZm9yIHN0ZXAgaW4gYnVpbGRbInN0ZXBzIl19CiAgICBjb21waWxlX2luZGljYXRvcnMgPSBzZXQoWyJjb21waWxlIiwgImNvbXBpbGUgKHdpdGggcGF0Y2gpIiwgImFuYWx5emUiXSkKICAgIGlmIGNvbXBpbGVfaW5kaWNhdG9ycyAmIHN0ZXBfbmFtZXM6CiAgICAgIHJldHVybiAiY29tcGlsZXMiCiAgICByZXR1cm4gImRvZXMgbm90IGNvbXBpbGUiCgogIGRlZiBQcmludENtZChzZWxmLCBjbWQsIGVudik6CiAgICBpZiBzZWxmLnBsYXRmb3JtID09ICd3aW4zMic6CiAgICAgIGVudl9wcmVmaXggPSAnc2V0ICcKICAgICAgZW52X3F1b3RlciA9IFF1b3RlRm9yU2V0CiAgICAgIHNoZWxsX3F1b3RlciA9IFF1b3RlRm9yQ21kCiAgICBlbHNlOgogICAgICBlbnZfcHJlZml4ID0gJycKICAgICAgZW52X3F1b3RlciA9IHNobGV4LnF1b3RlCiAgICAgIHNoZWxsX3F1b3RlciA9IHNobGV4LnF1b3RlCgogICAgZGVmIHByaW50X2Vudih2YXIpOgogICAgICBpZiBlbnYgYW5kIHZhciBpbiBlbnY6CiAgICAgICAgc2VsZi5QcmludCgnJXMlcz0lcycgJSAoZW52X3ByZWZpeCwgdmFyLCBlbnZfcXVvdGVyKGVudlt2YXJdKSkpCgogICAgcHJpbnRfZW52KCdMTFZNX0ZPUkNFX0hFQURfUkVWSVNJT04nKQoKICAgIGlmIGNtZFswXSA9PSBzZWxmLmV4ZWN1dGFibGU6CiAgICAgIGNtZCA9IFsncHl0aG9uJ10gKyBjbWRbMTpdCiAgICBzZWxmLlByaW50KCpbc2hlbGxfcXVvdGVyKGFyZykgZm9yIGFyZyBpbiBjbWRdKQoKICBkZWYgUHJpbnRKU09OKHNlbGYsIG9iaik6CiAgICBzZWxmLlByaW50KGpzb24uZHVtcHMob2JqLCBpbmRlbnQ9Miwgc29ydF9rZXlzPVRydWUpKQoKICBkZWYgQnVpbGQoc2VsZiwgdGFyZ2V0KToKICAgIGJ1aWxkX2RpciA9IHNlbGYuVG9TcmNSZWxQYXRoKHNlbGYuYXJncy5wYXRoWzBdKQogICAgbmluamFfY21kID0gWyduaW5qYScsICctQycsIGJ1aWxkX2Rpcl0KICAgIGlmIHNlbGYuYXJncy5qb2JzOgogICAgICBuaW5qYV9jbWQuZXh0ZW5kKFsnLWonLCAnJWQnICUgc2VsZi5hcmdzLmpvYnNdKQogICAgbmluamFfY21kLmFwcGVuZCh0YXJnZXQpCiAgICByZXQsIF8sIF8gPSBzZWxmLlJ1bihuaW5qYV9jbWQsIGZvcmNlX3ZlcmJvc2U9RmFsc2UsIGJ1ZmZlcl9vdXRwdXQ9RmFsc2UpCiAgICByZXR1cm4gcmV0CgogIGRlZiBSdW4oc2VsZiwgY21kLCBlbnY9Tm9uZSwgZm9yY2VfdmVyYm9zZT1UcnVlLCBidWZmZXJfb3V0cHV0PVRydWUpOgogICAgIyBUaGlzIGZ1bmN0aW9uIGxhcmdlbHkgZXhpc3RzIHNvIGl0IGNhbiBiZSBvdmVycmlkZGVuIGZvciB0ZXN0aW5nLgogICAgaWYgc2VsZi5hcmdzLmRyeXJ1biBvciBzZWxmLmFyZ3MudmVyYm9zZSBvciBmb3JjZV92ZXJib3NlOgogICAgICBzZWxmLlByaW50Q21kKGNtZCwgZW52KQogICAgaWYgc2VsZi5hcmdzLmRyeXJ1bjoKICAgICAgcmV0dXJuIDAsICcnLCAnJwoKICAgIHJldCwgb3V0LCBlcnIgPSBzZWxmLkNhbGwoY21kLCBlbnY9ZW52LCBidWZmZXJfb3V0cHV0PWJ1ZmZlcl9vdXRwdXQpCiAgICBpZiBzZWxmLmFyZ3MudmVyYm9zZSBvciBmb3JjZV92ZXJib3NlOgogICAgICBpZiByZXQ6CiAgICAgICAgc2VsZi5QcmludCgnICAtPiByZXR1cm5lZCAlZCcgJSByZXQpCiAgICAgIGlmIG91dDoKICAgICAgICBzZWxmLlByaW50KG91dCwgZW5kPScnKQogICAgICBpZiBlcnI6CiAgICAgICAgc2VsZi5QcmludChlcnIsIGVuZD0nJywgZmlsZT1zeXMuc3RkZXJyKQogICAgcmV0dXJuIHJldCwgb3V0LCBlcnIKCiAgZGVmIENhbGwoc2VsZiwgY21kLCBlbnY9Tm9uZSwgYnVmZmVyX291dHB1dD1UcnVlKToKICAgIGlmIGJ1ZmZlcl9vdXRwdXQ6CiAgICAgIHAgPSBzdWJwcm9jZXNzLlBvcGVuKGNtZCwgc2hlbGw9RmFsc2UsIGN3ZD1zZWxmLmNocm9taXVtX3NyY19kaXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudj1lbnYpCiAgICAgIG91dCwgZXJyID0gcC5jb21tdW5pY2F0ZSgpCiAgICAgIG91dCA9IG91dC5kZWNvZGUoJ3V0Zi04JykKICAgICAgZXJyID0gZXJyLmRlY29kZSgndXRmLTgnKQogICAgZWxzZToKICAgICAgcCA9IHN1YnByb2Nlc3MuUG9wZW4oY21kLCBzaGVsbD1GYWxzZSwgY3dkPXNlbGYuY2hyb21pdW1fc3JjX2RpciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgZW52PWVudikKICAgICAgcC53YWl0KCkKICAgICAgb3V0ID0gZXJyID0gJycKICAgIHJldHVybiBwLnJldHVybmNvZGUsIG91dCwgZXJyCgogIGRlZiBFeHBhbmRVc2VyKHNlbGYsIHBhdGgpOgogICAgIyBUaGlzIGZ1bmN0aW9uIGxhcmdlbHkgZXhpc3RzIHNvIGl0IGNhbiBiZSBvdmVycmlkZGVuIGZvciB0ZXN0aW5nLgogICAgcmV0dXJuIG9zLnBhdGguZXhwYW5kdXNlcihwYXRoKQoKICBkZWYgRXhpc3RzKHNlbGYsIHBhdGgpOgogICAgIyBUaGlzIGZ1bmN0aW9uIGxhcmdlbHkgZXhpc3RzIHNvIGl0IGNhbiBiZSBvdmVycmlkZGVuIGZvciB0ZXN0aW5nLgogICAgcmV0dXJuIG9zLnBhdGguZXhpc3RzKHBhdGgpCgogIGRlZiBGZXRjaChzZWxmLCB1cmwpOgogICAgIyBUaGlzIGZ1bmN0aW9uIGxhcmdlbHkgZXhpc3RzIHNvIGl0IGNhbiBiZSBvdmVycmlkZGVuIGZvciB0ZXN0aW5nLgogICAgZiA9IHVybG9wZW4odXJsKQogICAgY29udGVudHMgPSBmLnJlYWQoKQogICAgZi5jbG9zZSgpCiAgICByZXR1cm4gY29udGVudHMKCiAgZGVmIE1heWJlTWFrZURpcmVjdG9yeShzZWxmLCBwYXRoKToKICAgIHRyeToKICAgICAgb3MubWFrZWRpcnMocGF0aCkKICAgIGV4Y2VwdCBPU0Vycm9yIGFzIGU6CiAgICAgIGlmIGUuZXJybm8gIT0gZXJybm8uRUVYSVNUOgogICAgICAgIHJhaXNlCgogIGRlZiBQYXRoSm9pbihzZWxmLCAqY29tcHMpOgogICAgIyBUaGlzIGZ1bmN0aW9uIGxhcmdlbHkgZXhpc3RzIHNvIGl0IGNhbiBiZSBvdmVycmlkZW4gZm9yIHRlc3RpbmcuCiAgICByZXR1cm4gb3MucGF0aC5qb2luKCpjb21wcykKCiAgZGVmIFByaW50KHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAjIFRoaXMgZnVuY3Rpb24gbGFyZ2VseSBleGlzdHMgc28gaXQgY2FuIGJlIG92ZXJyaWRkZW4gZm9yIHRlc3RpbmcuCiAgICBwcmludCgqYXJncywgKiprd2FyZ3MpCiAgICBpZiBrd2FyZ3MuZ2V0KCdzdHJlYW0nLCBzeXMuc3Rkb3V0KSA9PSBzeXMuc3Rkb3V0OgogICAgICBzeXMuc3Rkb3V0LmZsdXNoKCkKCiAgZGVmIFJlYWRGaWxlKHNlbGYsIHBhdGgpOgogICAgIyBUaGlzIGZ1bmN0aW9uIGxhcmdlbHkgZXhpc3RzIHNvIGl0IGNhbiBiZSBvdmVycmlkZW4gZm9yIHRlc3RpbmcuCiAgICB3aXRoIG9wZW4ocGF0aCkgYXMgZnA6CiAgICAgIHJldHVybiBmcC5yZWFkKCkKCiAgZGVmIFJlbFBhdGgoc2VsZiwgcGF0aCwgc3RhcnQ9Jy4nKToKICAgICMgVGhpcyBmdW5jdGlvbiBsYXJnZWx5IGV4aXN0cyBzbyBpdCBjYW4gYmUgb3ZlcnJpZGVuIGZvciB0ZXN0aW5nLgogICAgcmV0dXJuIG9zLnBhdGgucmVscGF0aChwYXRoLCBzdGFydCkKCiAgZGVmIFJlbW92ZUZpbGUoc2VsZiwgcGF0aCk6CiAgICAjIFRoaXMgZnVuY3Rpb24gbGFyZ2VseSBleGlzdHMgc28gaXQgY2FuIGJlIG92ZXJyaWRlbiBmb3IgdGVzdGluZy4KICAgIG9zLnJlbW92ZShwYXRoKQoKICBkZWYgUmVtb3ZlRGlyZWN0b3J5KHNlbGYsIGFic19wYXRoKToKICAgIGlmIHNlbGYucGxhdGZvcm0gPT0gJ3dpbjMyJzoKICAgICAgIyBJbiBvdGhlciBwbGFjZXMgaW4gY2hyb21pdW0sIHdlIG9mdGVuIGhhdmUgdG8gcmV0cnkgdGhpcyBjb21tYW5kCiAgICAgICMgYmVjYXVzZSB3ZSdyZSB3b3JyaWVkIGFib3V0IG90aGVyIHByb2Nlc3NlcyBzdGlsbCBob2xkaW5nIG9uIHRvCiAgICAgICMgZmlsZSBoYW5kbGVzLCBidXQgd2hlbiBNQiBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIGVhcmx5IGVub3VnaCBpbiB0aGUKICAgICAgIyBidWlsZCB0aGF0IHRoZWlyIHNob3VsZCBiZSBubyBvdGhlciBwcm9jZXNzZXMgdG8gaW50ZXJmZXJlLiBXZQogICAgICAjIGNhbiBjaGFuZ2UgdGhpcyBpZiBuZWVkIGJlLgogICAgICBzZWxmLlJ1bihbJ2NtZC5leGUnLCAnL2MnLCAncm1kaXInLCAnL3EnLCAnL3MnLCBhYnNfcGF0aF0pCiAgICBlbHNlOgogICAgICBzaHV0aWwucm10cmVlKGFic19wYXRoLCBpZ25vcmVfZXJyb3JzPVRydWUpCgogIGRlZiBUZW1wRmlsZShzZWxmLCBtb2RlPSd3Jyk6CiAgICAjIFRoaXMgZnVuY3Rpb24gbGFyZ2VseSBleGlzdHMgc28gaXQgY2FuIGJlIG92ZXJyaWRlbiBmb3IgdGVzdGluZy4KICAgIHJldHVybiB0ZW1wZmlsZS5OYW1lZFRlbXBvcmFyeUZpbGUobW9kZT1tb2RlLCBkZWxldGU9RmFsc2UpCgogIGRlZiBXcml0ZUZpbGUoc2VsZiwgcGF0aCwgY29udGVudHMsIGZvcmNlX3ZlcmJvc2U9RmFsc2UpOgogICAgIyBUaGlzIGZ1bmN0aW9uIGxhcmdlbHkgZXhpc3RzIHNvIGl0IGNhbiBiZSBvdmVycmlkZW4gZm9yIHRlc3RpbmcuCiAgICBpZiBzZWxmLmFyZ3MuZHJ5cnVuIG9yIHNlbGYuYXJncy52ZXJib3NlIG9yIGZvcmNlX3ZlcmJvc2U6CiAgICAgIHNlbGYuUHJpbnQoJ1xuV3JpdGluZyAiIiJcXFxuJXMiIiIgdG8gJXMuXG4nICUgKGNvbnRlbnRzLCBwYXRoKSkKICAgIHdpdGggb3BlbihwYXRoLCAndycpIGFzIGZwOgogICAgICByZXR1cm4gZnAud3JpdGUoY29udGVudHMpCgoKY2xhc3MgTUJFcnIoRXhjZXB0aW9uKToKICBwYXNzCgoKIyBTZWUgdGhlIGZvbGxvd2luZyBsaW5rcyBmb3IgdGhlIHBhaW5mdWwgZGV0YWlscyBvZiB0aGlzIG5leHQgc2VjdGlvbiwgd2hpY2gKIyBoYW5kbGVzIGVzY2FwaW5nIGNvbW1hbmQgbGluZXMgc28gdGhhdCB0aGV5IGNhbiBiZSBjb3BpZWQgYW5kIHBhc3RlZCBpbnRvIGEKIyBjbWQgd2luZG93LgojIGh0dHBzOi8vbGVhcm4ubWljcm9zb2Z0LmNvbS9lbi1nYi9hcmNoaXZlL2Jsb2dzL3R3aXN0eWxpdHRsZXBhc3NhZ2VzYWxsYWxpa2UvZXZlcnlvbmUtcXVvdGVzLWNvbW1hbmQtbGluZS1hcmd1bWVudHMtdGhlLXdyb25nLXdheQojIGh0dHBzOi8vd2ViLmFyY2hpdmUub3JnL3dlYi8yMDE3MTAwNjA2MTIyMS9odHRwOi8vd3d3Lm1pY3Jvc29mdC5jb20vcmVzb3VyY2VzL2RvY3VtZW50YXRpb24vd2luZG93cy94cC9hbGwvcHJvZGRvY3MvZW4tdXMvc2V0Lm1zcHg/bWZyPXRydWUKIyBodHRwczovL2xlYXJuLm1pY3Jvc29mdC5jb20vZW4tdXMvd2luZG93cy1zZXJ2ZXIvYWRtaW5pc3RyYXRpb24vd2luZG93cy1jb21tYW5kcy9zZXRfMQpVTlNBRkVfRk9SX1NFVCA9IHNldCgnXjw+JnwnKQpVTlNBRkVfRk9SX0NNRCA9IFVOU0FGRV9GT1JfU0VULnVuaW9uKHNldCgnKCklJykpCkFMTF9NRVRBX0NIQVJTID0gVU5TQUZFX0ZPUl9DTUQudW5pb24oc2V0KCciJykpCgoKZGVmIFF1b3RlRm9yU2V0KGFyZyk6CiAgaWYgYW55KGEgaW4gVU5TQUZFX0ZPUl9TRVQgZm9yIGEgaW4gYXJnKToKICAgIGFyZyA9ICcnLmpvaW4oJ14nICsgYSBpZiBhIGluIFVOU0FGRV9GT1JfU0VUIGVsc2UgYSBmb3IgYSBpbiBhcmcpCiAgcmV0dXJuIGFyZwoKCmRlZiBRdW90ZUZvckNtZChhcmcpOgogICMgRmlyc3QsIGVzY2FwZSB0aGUgYXJnIHNvIHRoYXQgQ29tbWFuZExpbmVUb0FyZ3ZXIHdpbGwgcGFyc2UgaXQgcHJvcGVybHkuCiAgaWYgYXJnID09ICcnIG9yICcgJyBpbiBhcmcgb3IgJyInIGluIGFyZzoKICAgIHF1b3RlX3JlID0gcmUuY29tcGlsZShyJyhcXCopIicpCiAgICBhcmcgPSAnIiVzIicgJSAocXVvdGVfcmUuc3ViKGxhbWJkYSBtbzogMiAqIG1vLmdyb3VwKDEpICsgJ1xcIicsIGFyZykpCgogICMgVGhlbiBjaGVjayB0byBzZWUgaWYgdGhlIGFyZyBjb250YWlucyBhbnkgbWV0YWNoYXJhY3RlcnMgb3RoZXIgdGhhbgogICMgZG91YmxlIHF1b3RlczsgaWYgaXQgZG9lcywgcXVvdGUgZXZlcnl0aGluZyAoaW5jbHVkaW5nIHRoZSBkb3VibGUKICAjIHF1b3RlcykgZm9yIHNhZmV0eS4KICBpZiBhbnkoYSBpbiBVTlNBRkVfRk9SX0NNRCBmb3IgYSBpbiBhcmcpOgogICAgYXJnID0gJycuam9pbignXicgKyBhIGlmIGEgaW4gQUxMX01FVEFfQ0hBUlMgZWxzZSBhIGZvciBhIGluIGFyZykKICByZXR1cm4gYXJnCgoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICBzeXMuZXhpdChtYWluKHN5cy5hcmd2WzE6XSkp"
      run: |
        echo "$MB_SCRIPT" | base64 -d > ./v8/tools/mb/mb.py


    - name: Configure build arguments
      run: |
        cd v8
        ./tools/dev/v8gen.py x64.release -- \
          v8_monolithic=true \
          v8_use_external_startup_data=false \
          v8_static_library=true \
          v8_enable_disassembler=true \
          v8_enable_object_print=true \
          v8_enable_pointer_compression=false \
          is_component_build=false \
          is_debug=false
        # Verify configuration
        cat out.gn/x64.release/args.gn

    - name: Build V8 monolith
      run: |
        cd v8
        ninja -C out.gn/x64.release v8_monolith
        # Verify the build product
        ls -lh out.gn/x64.release/obj/libv8_monolith.a

    - name: Archive build artifacts
      run: |
        cd v8
        tar czvf v8-build.tar.gz \
          out.gn/x64.release/obj/libv8_monolith.a \
          include/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: v8-${{ inputs.v8_version }}-build
        path: v8/v8-build.tar.gz
